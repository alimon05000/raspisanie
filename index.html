<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Расписание">
    <meta name="theme-color" content="#0076f6">
    <meta name="description" content="Приложение для просмотра расписания занятий с системой объявлений">
    
    <title>Расписание группы</title>
    
    <!-- Иконки для Apple -->
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="apple-touch-startup-image" href="icons/icon-512x512.png">
    
    <!-- Манифест PWA -->
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogItCg0LDRgdGB0LvRjNCy0LDRjtCJINCy0L7RgdGC0LDQstC70Y/QvdC+0LUg0L/RgNC+0YTQtdGB0YHQuNC+0L3QsNC70YzQvdC+0LkiLAogICJzaG9ydF9uYW1lIjogItCg0LDRgdGB0LvRjNCy0LDRjiIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAic2NvcGUiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiMwMDc2ZjYiLAogICJkZXNjcmlwdGlvbiI6ICLQn9GA0LjQvNC10L3QuCDQstC+0YHRgtCw0LLQu9GP0L3QvtC1INGC0L7QsdC+0Lkg0LfQsNCy0LXRgNGI0LXQvdC40Y8g0YEg0YHQuNGB0YLQtdC80YsiLAogICJvcmllbnRhdGlvbiI6ICJwb3J0cmFpdCIsCiAgImNhdGVnb3JpZXMiOiBbCiAgICAiZWR1Y2F0aW9uIiwKICAgICJwcm9kdWN0aXZpdHkiCiAgXSwKICAibGFuZyI6ICJydSIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImljb25zL2ljb24tNzJ4NzIucG5nIiwKICAgICAgInNpemVzIjogIjcyeDcyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIgogICAgfSwKICAgIHsKICAgICAgInNyYyI6ICJpY29ucy9pY29uLTk2eDk2LnBuZyIsCiAgICAgICJzaXplcyI6ICI5Nng5NiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiaWNvbnMvaWNvbi0xMjh4MTI4LnBuZyIsCiAgICAgICJzaXplcyI6ICIxMjh4MTI4IiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIgogICAgfSwKICAgIHsKICAgICAgInNyYyI6ICJpY29ucy9pY29uLTE0NHgxNDQucG5nIiwKICAgICAgInNpemVzIjogIjE0NHgxNDQiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9LAogICAgewogICAgICAic3JjIjogImljb25zL2ljb24tMTUyeDE1Mi5wbmciLAogICAgICAic2l6ZXMiOiAiMTUyeDE1MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiaWNvbnMvaWNvbi0xOTJ4MTkyLnBuZyIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIgogICAgfSwKICAgIHsKICAgICAgInNyYyI6ICJpY29ucy9pY29uLTM4NHgzODQucG5nIiwKICAgICAgInNpemVzIjogIjM4NHgzODQiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9LAogICAgewogICAgICAic3JjIjogImljb25zL2ljb24tNTEyeDUxMi5wbmciLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0KICBdCn0=">
    
    <!-- Подключаем Firebase и LocalForage -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    
    <style>
        /* Все ваши существующие стили остаются без изменений */
        :root {
            --primary: #0076f6;
            --secondary: #6c757d;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --background: #ffffff;
            --text: #212529;
            --card-bg: #ffffff;
            --card-shadow: rgba(0, 0, 0, 0.1);
            --border-radius: 16px;
            --transition: all 0.3s ease;
            
            /* Цвета для темы жидкого стекла */
            --accent: #0A84FF;
            --green: #30D158;
            --yellow: #FFD60A;
            --red: #FF453A;
            --text-primary: rgba(0,0,0,.9);
            --text-secondary: rgba(0,0,0,.6);
            
            /* Переменные для эффекта жидкого стекла */
            --c-glass: #bbbbbc;
            --c-light: #fff;
            --c-dark: #000;
            --c-content: #224;
            --c-action: #0052f5;
            --c-bg: #E8E8E9;
            --glass-reflex-dark: 1;
            --glass-reflex-light: 1;
            --saturation: 150%;
        }

        .theme-glass {
            --background: linear-gradient(135deg, #8ec5fc 0%, #e0c3fc 100%);
            --card-bg: rgba(255, 255, 255, 0.25);
            --card-shadow: rgba(0, 0, 0, 0.1);
            --text: rgba(0, 0, 0, 0.9);
            --primary: #7b68ee;
            --secondary: rgba(0, 0, 0, 0.7);
            --border-radius: 20px;
            --text-primary: rgba(0, 0, 0, 0.9);
            --text-secondary: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            background-color: rgba(255, 255, 255, 0.1);
            
            /* Переменные для эффекта жидкого стекла */
            --c-glass: #bbbbbc;
            --c-light: #fff;
            --c-dark: #000;
            --c-content: rgba(0, 0, 0, 0.9);
            --c-action: #7b68ee;
            --c-bg: linear-gradient(135deg, #8ec5fc 0%, #e0c3fc 100%);
            --glass-reflex-dark: 1;
            --glass-reflex-light: 1;
            --saturation: 150%;
        }

        .theme-dark {
            --background: #1a1a1a;
            --card-bg: rgba(0, 0, 0, 0.2);
            --card-shadow: rgba(0, 0, 0, 0.3);
            --text: rgba(255,255,255,.92);
            --text-primary: rgba(255,255,255,.92);
            --text-secondary: rgba(255,255,255,.6);
            
            /* Переменные для эффекта жидкого стекла */
            --c-glass: #bbbbbc;
            --c-light: #fff;
            --c-dark: #000;
            --c-content: rgba(255,255,255,.92);
            --c-action: #03d5ff;
            --c-bg: #1b1b1d;
            --glass-reflex-dark: 2;
            --glass-reflex-light: 0.3;
            --saturation: 150%;
        }

        .theme-galaxy {
            --background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            --card-bg: rgba(255, 255, 255, 0.15);
            --card-shadow: rgba(0, 0, 0, 0.4);
            --text: rgba(255,255,255,.95);
            --primary: #9D4EDD;
            --secondary: rgba(255,255,255,.8);
            --border-radius: 20px;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            background-color: rgba(0, 0, 0, 0.2);
            
            /* Переменные для эффекта жидкого стекла */
            --c-light: #99deff;
            --c-dark: #20001b;
            --c-glass: hsl(335 250% 74% / 1);
            --c-content: #d5dbe2;
            --c-action: #ff48a9;
            --c-bg: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            --glass-reflex-dark: 2;
            --glass-reflex-light: 0.7;
            --saturation: 200%;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: var(--transition);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--background);
            color: var(--text);
            min-height: 100vh;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            overflow-x: hidden;
        }

        /* Фон с параллакс эффектом */
        .parallax-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(circle at 30% 40%, rgba(255, 255, 255, 0.4) 0%, rgba(255, 255, 255, 0.1) 40%, rgba(255, 255, 255, 0) 70%),
                        radial-gradient(circle at 70% 60%, rgba(200, 220, 255, 0.3) 0%, rgba(200, 220, 255, 0.1) 30%, rgba(200, 220, 255, 0) 60%);
            background-attachment: fixed;
            pointer-events: none;
        }

        .theme-glass .parallax-bg {
            background: radial-gradient(circle at 30% 40%, rgba(255, 255, 255, 0.6) 0%, rgba(240, 240, 240, 0.3) 40%, rgba(220, 220, 220, 0.1) 70%),
                        radial-gradient(circle at 70% 60%, rgba(200, 220, 255, 0.5) 0%, rgba(180, 200, 240, 0.3) 30%, rgba(160, 180, 220, 0.1) 60%);
        }

        .theme-dark .parallax-bg {
            background: radial-gradient(circle at 30% 40%, rgba(100, 100, 255, 0.2) 0%, rgba(80, 80, 200, 0.1) 40%, rgba(0, 0, 0, 0) 70%),
                        radial-gradient(circle at 70% 60%, rgba(150, 100, 255, 0.2) 0%, rgba(120, 80, 200, 0.1) 30%, rgba(0, 0, 0, 0) 60%),
                        #1a1a1a;
        }

        .theme-galaxy .parallax-bg {
            background: radial-gradient(circle at 30% 40%, rgba(157, 78, 221, 0.4) 0%, rgba(77, 25, 127, 0.3) 40%, rgba(0, 0, 0, 0) 70%),
                        radial-gradient(circle at 70% 60%, rgba(255, 107, 107, 0.3) 0%, rgba(214, 93, 177, 0.2) 30%, rgba(0, 0, 0, 0) 60%),
                        linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
        }

        .app-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 15px 0;
            position: relative;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(45deg, var(--primary), var(--info));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .theme-glass h1 {
            background: linear-gradient(45deg, #7b68ee, #6a5acd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .theme-galaxy h1 {
            background: linear-gradient(45deg, #9D4EDD, #FF6B6B);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .week-indicator {
            background: var(--card-bg);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            box-shadow: 0 10px 30px rgba(0,0,0,.12), 0 1px 0 rgba(255,255,255,.06) inset;
            border: 1px solid rgba(255,255,255,0.1);
            
            /* Эффект жидкого стекла */
            background-color: color-mix(in srgb, var(--c-glass) 12%, transparent);
            backdrop-filter: blur(8px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(8px) saturate(var(--saturation));
            box-shadow: 
                inset 0 0 0 1px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 10%), transparent),
                inset 1.8px 3px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 90%), transparent), 
                inset -2px -2px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 80%), transparent), 
                inset -3px -8px 1px -6px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 60%), transparent), 
                inset -0.3px -1px 4px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 12%), transparent), 
                inset -1.5px 2.5px 0px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 0px 3px 4px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 2px -6.5px 1px -4px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 1px 5px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 6px 16px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 8%), transparent);
        }

        .theme-selector {
            position: relative;
        }

        .theme-button {
            background: var(--card-bg);
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px var(--card-shadow);
            color: var(--text);
            
            /* Эффект жидкого стекла */
            background-color: color-mix(in srgb, var(--c-glass) 12%, transparent);
            backdrop-filter: blur(8px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(8px) saturate(var(--saturation));
            box-shadow: 
                inset 0 0 0 1px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 10%), transparent),
                inset 1.8px 3px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 90%), transparent), 
                inset -2px -2px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 80%), transparent), 
                inset -3px -8px 1px -6px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 60%), transparent), 
                inset -0.3px -1px 4px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 12%), transparent), 
                inset -1.5px 2.5px 0px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 0px 3px 4px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 2px -6.5px 1px -4px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 1px 5px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 6px 16px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 8%), transparent);
        }

        .theme-options {
            position: absolute;
            top: 50px;
            right: 0;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 10px;
            box-shadow: 0 10px 25px var(--card-shadow);
            display: none;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
            width: 150px;
            
            /* Эффект жидкого стекла */
            background-color: color-mix(in srgb, var(--c-glass) 12%, transparent);
            backdrop-filter: blur(20px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(20px) saturate(var(--saturation));
            box-shadow: 
                inset 0 0 0 1px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 10%), transparent),
                inset 1.8px 3px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 90%), transparent), 
                inset -2px -2px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 80%), transparent), 
                inset -3px -8px 1px -6px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 60%), transparent), 
                inset -0.3px -1px 4px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 12%), transparent), 
                inset -1.5px 2.5px 0px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 0px 3px 4px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 2px -6.5px 1px -4px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 1px 5px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 6px 16px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 8%), transparent);
        }

        .theme-option {
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            font-weight: 500;
            background-color: color-mix(in srgb, var(--c-glass) 8%, transparent);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .theme-option:hover {
            background: rgba(0,0,0,0.05);
            background-color: color-mix(in srgb, var(--c-glass) 20%, transparent);
        }

        /* Навигация между разделами - ИСПРАВЛЕНА АДАПТАЦИЯ */
        .app-navigation {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            overflow-x: auto;
            padding: 5px 0;
            scrollbar-width: none;
            gap: 8px;
        }

        .app-navigation::-webkit-scrollbar {
            display: none;
        }

        .nav-button {
            padding: 12px 8px;
            border-radius: var(--border-radius);
            background: var(--card-bg);
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--text);
            white-space: nowrap;
            box-shadow: 0 4px 8px var(--card-shadow);
            flex: 1;
            min-width: 0;
            text-align: center;
            font-size: 0.85rem;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            
            /* Эффект жидкого стекла */
            background-color: color-mix(in srgb, var(--c-glass) 12%, transparent);
            backdrop-filter: blur(8px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(8px) saturate(var(--saturation));
            box-shadow: 
                inset 0 0 0 1px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 10%), transparent),
                inset 1.8px 3px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 90%), transparent), 
                inset -2px -2px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 80%), transparent), 
                inset -3px -8px 1px -6px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 60%), transparent), 
                inset -0.3px -1px 4px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 12%), transparent), 
                inset -1.5px 2.5px 0px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 0px 3px 4px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 2px -6.5px 1px -4px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 1px 5px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 6px 16px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 8%), transparent);
        }

        .nav-button.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 6px 15px rgba(10,132,255,0.4);
            
            /* Эффект жидкого стекла для активной кнопки */
            background-color: color-mix(in srgb, var(--c-action) 80%, transparent);
            backdrop-filter: blur(12px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(12px) saturate(var(--saturation));
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Стили для расписания - ИСПРАВЛЕНА АДАПТАЦИЯ */
        .day-navigation {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            overflow-x: auto;
            padding: 5px 0;
            scrollbar-width: none;
            gap: 8px;
        }

        .day-navigation::-webkit-scrollbar {
            display: none;
        }

        .day-button {
            padding: 12px 8px;
            border-radius: var(--border-radius);
            background: var(--card-bg);
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--text);
            white-space: nowrap;
            box-shadow: 0 4px 8px var(--card-shadow);
            flex: 1;
            min-width: 0;
            text-align: center;
            font-size: 0.85rem;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            
            /* Эффект жидкого стекла */
            background-color: color-mix(in srgb, var(--c-glass) 12%, transparent);
            backdrop-filter: blur(8px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(8px) saturate(var(--saturation));
            box-shadow: 
                inset 0 0 0 1px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 10%), transparent),
                inset 1.8px 3px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 90%), transparent), 
                inset -2px -2px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 80%), transparent), 
                inset -3px -8px 1px -6px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 60%), transparent), 
                inset -0.3px -1px 4px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 12%), transparent), 
                inset -1.5px 2.5px 0px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 0px 3px 4px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 2px -6.5px 1px -4px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 1px 5px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 6px 16px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 8%), transparent);
        }

        .day-button.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 6px 15px rgba(10,132,255,0.4);
            
            /* Эффект жидкого стекла для активной кнопки */
            background-color: color-mix(in srgb, var(--c-action) 80%, transparent);
            backdrop-filter: blur(12px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(12px) saturate(var(--saturation));
        }

        .schedule-container {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 10px 30px var(--card-shadow);
            margin-bottom: 30px;
            
            /* Эффект жидкого стекла */
            background-color: color-mix(in srgb, var(--c-glass) 12%, transparent);
            backdrop-filter: blur(20px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(20px) saturate(var(--saturation));
            box-shadow: 
                inset 0 0 0 1px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 10%), transparent),
                inset 1.8px 3px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 90%), transparent), 
                inset -2px -2px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 80%), transparent), 
                inset -3px -8px 1px -6px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 60%), transparent), 
                inset -0.3px -1px 4px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 12%), transparent), 
                inset -1.5px 2.5px 0px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 0px 3px 4px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 2px -6.5px 1px -4px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 1px 5px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 6px 16px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 8%), transparent);
        }

        .day-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 700;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
        }

        .lesson {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 12px;
            background: rgba(0,0,0,0.03);
            border-left: 4px solid var(--primary);
            position: relative;
            
            /* Эффект жидкого стекла */
            background-color: color-mix(in srgb, var(--c-glass) 8%, transparent);
            backdrop-filter: blur(12px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(12px) saturate(var(--saturation));
            box-shadow: 
                inset 0 0 0 1px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 10%), transparent),
                inset 1.8px 3px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 90%), transparent), 
                inset -2px -2px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 80%), transparent), 
                inset -3px -8px 1px -6px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 60%), transparent), 
                inset -0.3px -1px 4px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 12%), transparent), 
                inset -1.5px 2.5px 0px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 0px 3px 4px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 2px -6.5px 1px -4px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent);
        }

        .lesson-number {
            position: absolute;
            top: -10px;
            left: -10px;
            background: var(--primary);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .lesson-time {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .time-remaining {
            font-size: 0.8rem;
            background: rgba(0,0,0,0.1);
            padding: 2px 6px;
            border-radius: 8px;
            margin-left: 5px;
        }

        .theme-galaxy .time-remaining {
            background: rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.9);
        }

        .lesson-name {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .lesson-type {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .lecture {
            background-color: rgba(10, 132, 255, 0.15);
            color: var(--accent);
        }

        .practice {
            background-color: rgba(48, 209, 88, 0.15);
            color: var(--green);
        }

        .seminar {
            background-color: rgba(255, 193, 7, 0.15);
            color: var(--warning);
        }

        .lesson-details {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 0.9rem;
            color: var(--secondary);
        }

        .lesson-detail {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .empty-schedule {
            text-align: center;
            padding: 30px;
            color: var(--secondary);
            font-style: italic;
        }

        /* Стили для заметок */
        .notes-container {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 10px 30px var(--card-shadow);
            margin-bottom: 30px;
            
            /* Эффект жидкого стекла */
            background-color: color-mix(in srgb, var(--c-glass) 12%, transparent);
            backdrop-filter: blur(20px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(20px) saturate(var(--saturation));
            box-shadow: 
                inset 0 0 0 1px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 10%), transparent),
                inset 1.8px 3px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 90%), transparent), 
                inset -2px -2px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 80%), transparent), 
                inset -3px -8px 1px -6px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 60%), transparent), 
                inset -0.3px -1px 4px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 12%), transparent), 
                inset -1.5px 2.5px 0px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 0px 3px 4px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 2px -6.5px 1px -4px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 1px 5px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 6px 16px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 8%), transparent);
        }

        .notes-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 700;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
        }

        .note {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 12px;
            background: rgba(0,0,0,0.03);
            border-left: 4px solid var(--success);
            position: relative;
            
            /* Эффект жидкого стекла */
            background-color: color-mix(in srgb, var(--c-glass) 8%, transparent);
            backdrop-filter: blur(12px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(12px) saturate(var(--saturation));
            box-shadow: 
                inset 0 0 0 1px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 10%), transparent),
                inset 1.8px 3px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 90%), transparent), 
                inset -2px -2px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 80%), transparent), 
                inset -3px -8px 1px -6px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 60%), transparent), 
                inset -0.3px -1px 4px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 12%), transparent), 
                inset -1.5px 2.5px 0px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 0px 3px 4px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 2px -6.5px 1px -4px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent);
        }

        .note-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .note-content {
            margin-bottom: 10px;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .note-date {
            font-size: 0.8rem;
            color: var(--secondary);
            text-align: right;
        }

        /* Стили для календаря */
        .calendar-container {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 10px 30px var(--card-shadow);
            margin-bottom: 30px;
            
            /* Эффект жидкого стекла */
            background-color: color-mix(in srgb, var(--c-glass) 12%, transparent);
            backdrop-filter: blur(20px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(20px) saturate(var(--saturation));
            box-shadow: 
                inset 0 0 0 1px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 10%), transparent),
                inset 1.8px 3px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 90%), transparent), 
                inset -2px -2px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 80%), transparent), 
                inset -3px -8px 1px -6px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 60%), transparent), 
                inset -0.3px -1px 4px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 12%), transparent), 
                inset -1.5px 2.5px 0px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 0px 3px 4px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 2px -6.5px 1px -4px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 1px 5px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 6px 16px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 8%), transparent);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .calendar-nav-button {
            background: var(--primary);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 15px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            padding: 8px 0;
            font-size: 0.9rem;
            color: var(--secondary);
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            background: rgba(0,0,0,0.03);
            
            /* Эффект жидкого стекла */
            background-color: color-mix(in srgb, var(--c-glass) 8%, transparent);
            backdrop-filter: blur(8px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(8px) saturate(var(--saturation));
        }

        .calendar-day:hover {
            background: var(--primary);
            color: white;
        }

        .calendar-day.today {
            background: var(--primary);
            color: white;
            font-weight: bold;
        }

        .calendar-day.other-month {
            color: var(--secondary);
            opacity: 0.5;
        }

        .calendar-events {
            margin-top: 20px;
        }

        .calendar-event {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            background: rgba(0,0,0,0.03);
            border-left: 3px solid var(--primary);
            
            /* Эффект жидкого стекла */
            background-color: color-mix(in srgb, var(--c-glass) 8%, transparent);
            backdrop-filter: blur(8px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(8px) saturate(var(--saturation));
        }

        .event-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .event-time {
            font-size: 0.8rem;
            color: var(--secondary);
        }

        .add-event-button {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: none;
            background: var(--success);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
        }

        /* Стили для создания заметок */
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .logout-button {
            padding: 6px 12px;
            border-radius: 8px;
            border: none;
            background: var(--danger);
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .add-note-button {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: none;
            background: var(--success);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
        }

        .note-form {
            display: none;
            margin-top: 20px;
        }

        .note-input, .note-textarea {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            border: 1px solid rgba(0,0,0,0.1);
            background: rgba(255,255,255,0.8);
            font-size: 1rem;
            color: var(--text);
        }

        .theme-glass .note-input, .theme-glass .note-textarea {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .theme-galaxy .note-input, .theme-galaxy .note-textarea {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
        }

        .note-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .note-actions {
            display: flex;
            gap: 10px;
        }

        .note-submit {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: none;
            background: var(--success);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .note-cancel {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: none;
            background: var(--danger);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        /* Стили для загрузки изображений */
        .image-upload-container {
            margin-bottom: 15px;
        }

        .image-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 8px;
            display: none;
        }

        .image-remove {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            margin-top: 5px;
            display: none;
        }

        /* Оффлайн уведомление */
        .offline-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            padding: 10px 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px var(--card-shadow);
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 10px;
            
            /* Эффект жидкого стекла */
            background-color: color-mix(in srgb, var(--c-glass) 12%, transparent);
            backdrop-filter: blur(20px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(20px) saturate(var(--saturation));
        }
        
        /* Кнопка обновления */
        .refresh-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px var(--card-shadow);
            z-index: 100;
            border: none;
            
            /* Эффект жидкого стекла */
            background-color: color-mix(in srgb, var(--c-action) 80%, transparent);
            backdrop-filter: blur(12px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(12px) saturate(var(--saturation));
            box-shadow: 
                inset 0 0 0 1px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 10%), transparent),
                inset 1.8px 3px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 90%), transparent), 
                inset -2px -2px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 80%), transparent), 
                inset -3px -8px 1px -6px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 60%), transparent), 
                inset -0.3px -1px 4px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 12%), transparent), 
                inset -1.5px 2.5px 0px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 0px 3px 4px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 2px -6.5px 1px -4px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 1px 5px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 6px 16px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 8%), transparent);
        }

        /* Синхронизация статуса */
        .sync-status {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            padding: 8px 16px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px var(--card-shadow);
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            
            /* Эффект жидкого стекла */
            background-color: color-mix(in srgb, var(--c-glass) 12%, transparent);
            backdrop-filter: blur(20px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(20px) saturate(var(--saturation));
        }

        /* Напоминание о расписании */
        .reminder-banner {
            background: linear-gradient(135deg, var(--warning), var(--yellow));
            color: black;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
            display: none;
            align-items: center;
            justify-content: center;
            gap: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .theme-glass .reminder-banner {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.9), rgba(255, 214, 10, 0.9));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        /* Стили для чата с AI */
        .chat-container {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 10px 30px var(--card-shadow);
            margin-bottom: 30px;
            height: 70vh;
            display: flex;
            flex-direction: column;
            
            /* Эффект жидкого стекла */
            background-color: color-mix(in srgb, var(--c-glass) 12%, transparent);
            backdrop-filter: blur(20px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(20px) saturate(var(--saturation));
            box-shadow: 
                inset 0 0 0 1px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 10%), transparent),
                inset 1.8px 3px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 90%), transparent), 
                inset -2px -2px 0px -2px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 80%), transparent), 
                inset -3px -8px 1px -6px color-mix(in srgb, var(--c-light) calc(var(--glass-reflex-light) * 60%), transparent), 
                inset -0.3px -1px 4px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 12%), transparent), 
                inset -1.5px 2.5px 0px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 0px 3px 4px -2px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 20%), transparent), 
                inset 2px -6.5px 1px -4px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 1px 5px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 10%), transparent), 
                0px 6px 16px 0px color-mix(in srgb, var(--c-dark) calc(var(--glass-reflex-dark) * 8%), transparent);
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
        }

        .chat-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .chat-controls {
            display: flex;
            gap: 10px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 10px;
            background: rgba(0,0,0,0.03);
            
            /* Эффект жидкого стекла */
            background-color: color-mix(in srgb, var(--c-glass) 8%, transparent);
            backdrop-filter: blur(12px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(12px) saturate(var(--saturation));
        }

        .message {
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .user-message {
            background: var(--primary);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .ai-message {
            background: rgba(0,0,0,0.05);
            color: var(--text);
            margin-right: auto;
            border-bottom-left-radius: 5px;
            
            /* Эффект жидкого стекла */
            background-color: color-mix(in srgb, var(--c-glass) 8%, transparent);
            backdrop-filter: blur(8px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(8px) saturate(var(--saturation));
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border-radius: 25px;
            border: 1px solid rgba(0,0,0,0.1);
            background: rgba(255,255,255,0.8);
            font-size: 1rem;
            color: var(--text);
        }

        .theme-glass .chat-input {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .theme-galaxy .chat-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
        }

        .chat-send {
            padding: 12px 20px;
            border-radius: 25px;
            border: none;
            background: var(--success);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .beta-badge {
            background: var(--warning);
            color: black;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .typing-indicator {
            display: none;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 15px;
            background: rgba(0,0,0,0.05);
            color: var(--text);
            margin-right: auto;
            border-bottom-left-radius: 5px;
            max-width: 80px;
            
            /* Эффект жидкого стекла */
            background-color: color-mix(in srgb, var(--c-glass) 8%, transparent);
            backdrop-filter: blur(8px) saturate(var(--saturation));
            -webkit-backdrop-filter: blur(8px) saturate(var(--saturation));
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--secondary);
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* Медиа-запросы для мобильных устройств */
        @media (max-width: 480px) {
            .app-container {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .day-button, .nav-button {
                padding: 10px 6px;
                font-size: 0.8rem;
                min-width: 50px;
            }
            
            .lesson {
                padding: 12px;
            }
            
            .lesson-name {
                font-size: 1rem;
            }

            .schedule-container, .notes-container, .calendar-container, .chat-container {
                padding: 16px;
            }
            
            .message {
                max-width: 90%;
            }
            
            .chat-controls {
                flex-direction: column;
                gap: 5px;
            }
            
            .chat-title {
                font-size: 1.3rem;
            }
            
            .chat-send {
                padding: 12px 15px;
            }
        }

        /* Анимации */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .schedule-container, .notes-container, .calendar-container, .chat-container {
            animation: fadeIn 0.5s ease;
        }

        .lesson, .note, .calendar-event, .message {
            animation: fadeIn 0.5s ease;
            animation-fill-mode: both;
        }

        .lesson:nth-child(1) { animation-delay: 0.1s; }
        .lesson:nth-child(2) { animation-delay: 0.2s; }
        .lesson:nth-child(3) { animation-delay: 0.3s; }
        .lesson:nth-child(4) { animation-delay: 0.4s; }
        .lesson:nth-child(5) { animation-delay: 0.5s; }
    </style>
</head>
<body>
    <div class="parallax-bg"></div>
    
    <div class="app-container">
        <header>
            <h1>Расписание</h1>
            <div class="week-indicator" id="weekIndicator">Неделя 1</div>
            <div class="theme-selector">
                <button class="theme-button" id="themeButton">🎨</button>
                <div class="theme-options" id="themeOptions">
                    <div class="theme-option" data-theme="default">Стандартная</div>
                    <div class="theme-option" data-theme="glass">Жидкое стекло</div>
                    <div class="theme-option" data-theme="dark">Тёмная</div>
                    <div class="theme-option" data-theme="galaxy">Галактика</div>
                </div>
            </div>
        </header>

        <!-- Статус синхронизации -->
        <div class="sync-status" id="syncStatus">
            <span id="syncText">Синхронизация...</span>
        </div>

        <!-- Напоминание о расписании -->
        <div class="reminder-banner" id="reminderBanner">
            <span>📚</span>
            <span>Не забудьте посмотреть расписание на сегодня!</span>
            <button onclick="hideReminder()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; margin-left: 10px;">✕</button>
        </div>

        <!-- Навигация между разделами -->
        <div class="app-navigation">
            <button class="nav-button active" onclick="showSection('schedule')">Расписание</button>
            <button class="nav-button" onclick="showSection('notes')">Мои заметки</button>
            <button class="nav-button" onclick="showSection('calendar')">Календарь</button>
            <button class="nav-button" onclick="showSection('chat')">AI Помощник <span class="beta-badge">PRO</span></button>
        </div>

        <!-- Раздел расписания -->
        <div class="section active" id="scheduleSection">
            <div class="day-navigation">
                <button class="day-button active" data-day="0">Пн</button>
                <button class="day-button" data-day="1">Вт</button>
                <button class="day-button" data-day="2">Ср</button>
                <button class="day-button" data-day="3">Чт</button>
                <button class="day-button" data-day="4">Пт</button>
                <button class="day-button" data-day="5">Сб</button>
                <button class="day-button" data-day="6">Вс</button>
            </div>

            <div class="schedule-container">
                <h2 class="day-title">Понедельник</h2>
                <div id="scheduleContent">
                    <!-- Расписание будет загружено здесь -->
                </div>
            </div>
        </div>

        <!-- Раздел заметок -->
        <div class="section" id="notesSection">
            <div class="notes-container">
                <h2 class="notes-title">Мои заметки</h2>
                <button class="add-note-button" id="addNoteButton">Добавить заметку</button>
                
                <div class="note-form" id="noteForm">
                    <input type="text" class="note-input" id="noteTitle" placeholder="Заголовок заметки">
                    <textarea class="note-textarea" id="noteContent" placeholder="Текст заметки"></textarea>
                    
                    <!-- Контейнер для загрузки изображений -->
                    <div class="image-upload-container">
                        <input type="file" id="noteImage" accept="image/*" style="display: none;">
                        <button type="button" id="imageUploadButton" class="note-submit" style="background: var(--info);">Добавить изображение</button>
                        <img id="imagePreview" class="image-preview">
                        <button type="button" id="imageRemoveButton" class="image-remove">Удалить изображение</button>
                    </div>
                    
                    <div class="note-actions">
                        <button class="note-submit" id="noteSubmit">Сохранить</button>
                        <button class="note-cancel" id="noteCancel">Отмена</button>
                    </div>
                </div>
                
                <div id="notesContent">
                    <!-- Заметки будут загружены здесь -->
                </div>
            </div>
        </div>

        <!-- Раздел календаря -->
        <div class="section" id="calendarSection">
            <div class="calendar-container">
                <div class="calendar-header">
                    <h2 class="calendar-title" id="calendarTitle">Январь 2024</h2>
                    <div class="calendar-nav">
                        <button class="calendar-nav-button" id="prevMonth">‹</button>
                        <button class="calendar-nav-button" id="nextMonth">›</button>
                    </div>
                </div>
                
                <div class="calendar-grid" id="calendarGrid">
                    <!-- Календарь будет сгенерирован здесь -->
                </div>
                
                <div class="calendar-events" id="calendarEvents">
                    <h3>События на выбранную дату</h3>
                    <!-- События будут отображены здесь -->
                </div>
                
                <button class="add-event-button" id="addEventButton">Добавить событие</button>
            </div>
        </div>

        <!-- Раздел чата с AI -->
        <div class="section" id="chatSection">
            <div class="chat-container">
                <div class="chat-header">
                    <h2 class="chat-title">AI Помощник PRO</h2>
                    <div class="chat-controls">
                        <button class="logout-button" onclick="newChat()">Новый чат</button>
                        <button class="logout-button" onclick="clearChat()">Очистить чат</button>
                        <button class="logout-button" id="aiStatusButton" style="background: var(--success); color: black;">AI: Активен</button>
                    </div>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <!-- Сообщения чата будут здесь -->
                    <div class="message ai-message">
                        Привет! Я ваш продвинутый AI помощник. Я обладаю расширенными знаниями в технических, научных, культурных и бытовых вопросах. Могу помочь с учебой, объяснить сложные концепции, помочь с анализом и решением задач. Чем могу помочь?
                    </div>
                </div>
                <div class="typing-indicator" id="typingIndicator">
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Введите ваш вопрос...">
                    <button class="chat-send" id="chatSend">Отправить</button>
                </div>
            </div>
        </div>

        <footer>
            Обновляется автоматически • <span id="lastUpdated"></span>
        </footer>
    </div>
    
    <div class="offline-notification" id="offlineNotification">
        <span>⚠️</span> Работает в оффлайн-режиме
    </div>
    
    <button class="refresh-button" id="refreshButton" title="Обновить расписание">↻</button>

    <script>
        // Конфигурация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCYVxpEkzR01G1wxt-dMsLv-nqVoIiMOyE",
            authDomain: "raspisanie-fbdfa.firebaseapp.com",
            projectId: "raspisanie-fbdfa",
            storageBucket: "raspisanie-fbdfa.firebasestorage.app",
            messagingSenderId: "462401081461",
            appId: "1:462401081461:web:f09bb2ab71b3a526bae83c",
            measurementId: "G-73VTNVX55B"
        };

        // Инициализация Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase успешно инициализирован");
        } catch (error) {
            console.error("Ошибка инициализации Firebase:", error);
        }
        
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Инициализация LocalForage
        const localForage = localforage.createInstance({
            name: "scheduleApp",
            version: 1.0,
            storeName: "schedule_data"
        });

        // РАСШИРЕННАЯ БАЗА ЗНАНИЙ ДЛЯ AI ПОМОЩНИКА
        const advancedKnowledgeBase = {
            // Технические знания (ваши предметы + расширенные)
            technical: {
                "Релейная защита и противоаварийная автоматика": {
                    description: "Дисциплина, изучающая принципы защиты электроэнергетических систем от аварийных режимов работы с использованием релейной аппаратуры",
                    detailedExplanation: "Релейная защита - это комплекс автоматических устройств, предназначенных для быстрого выявления и отключения поврежденного оборудования. Основные принципы: селективность, чувствительность, быстродействие и надежность.",
                    topics: [
                        "Релейная защита линий электропередачи",
                        "Дифференциальная защита трансформаторов",
                        "Защита шин распределительных устройств",
                        "Автоматическое повторное включение",
                        "Автоматическая частотная разгрузка",
                        "Дистанционная защита",
                        "Токовая отсечка",
                        "Максимальная токовая защита"
                    ],
                    keyTerms: {
                        "Реле": "Устройство, автоматически реагирующее на изменение контролируемой величины и выдающее сигнал для управления",
                        "Ток срабатывания": "Значение тока, при котором защита начинает действовать",
                        "Выдержка времени": "Временная задержка срабатывания защиты для обеспечения селективности",
                        "Селективность": "Свойство защиты отключать только поврежденный элемент системы",
                        "Чувствительность": "Способность защиты реагировать на повреждения в конце защищаемой зоны",
                        "Надежность": "Свойство защиты выполнять свои функции при повреждениях в защищаемой зоне",
                        "Быстродействие": "Скорость срабатывания защиты, измеряемая в миллисекундах"
                    },
                    practicalApplications: [
                        "Защита трансформаторов от внутренних повреждений",
                        "Защита ЛЭП от междуфазных коротких замыканий",
                        "Защита генераторов от перегрузок",
                        "Автоматическое восстановление питания"
                    ],
                    teachers: ["Ниналалов С.А."],
                    examInfo: "Экзамен включает теоретические вопросы и практические задачи по расчету уставок защит. Необходимо знать принципы действия основных видов защит.",
                    practicalTasks: [
                        "Расчет токов короткого замыкания для различных точек сети",
                        "Выбор уставок релейной защиты",
                        "Проверка чувствительности защит",
                        "Составление схем релейной защиты"
                    ]
                },
                
                "Геотермальная энергетика": {
                    description: "Раздел энергетики, связанный с использованием тепловой энергии Земли для генерации электроэнергии и теплоснабжения",
                    detailedExplanation: "Геотермальная энергетика использует тепло земных недр, которое является возобновляемым источником энергии. Температура увеличивается с глубиной (геотермический градиент составляет примерно 3°C на 100 метров).",
                    topics: [
                        "Геотермальные ресурсы и их классификация",
                        "Типы геотермальных систем: гидротермальные, петротермальные",
                        "Геотермальные электростанции: прямого пара, флеш-испарения, бинарного цикла",
                        "Прямое использование геотермального тепла",
                        "Бурение геотермальных скважин",
                        "Термодинамические циклы в геотермальной энергетике",
                        "Экологические аспекты геотермальной энергетики"
                    ],
                    keyTerms: {
                        "Геотермальный градиент": "Увеличение температуры горных пород с глубиной",
                        "Горячие сухие породы": "Горные породы с высокой температурой, но без природного теплоносителя",
                        "Геотермальный резервуар": "Подземный объем породы, содержащий теплоноситель (воду или пар)",
                        "Бинарный цикл": "Технология преобразования низкопотенциального тепла в электричество с использованием рабочего тела с низкой температурой кипения",
                        "Флеш-испарение": "Процесс мгновенного испарения горячей воды при снижении давления",
                        "Геотермальный теплоноситель": "Вода или пар, используемые для передачи тепла из недр Земли"
                    },
                    practicalApplications: [
                        "Производство электроэнергии в вулканических регионах",
                        "Отопление жилых и промышленных зданий",
                        "Тепличное хозяйство",
                        "Бальнеология и рекреация"
                    ],
                    teachers: ["Алхасова Д.А."],
                    examInfo: "Зачет с защитой проекта по геотермальной установке. Необходимо понимать принципы работы разных типов ГеоЭС.",
                    practicalTasks: [
                        "Расчет потенциала геотермального месторождения",
                        "Проектирование геотермальной электростанции",
                        "Анализ эффективности геотермальных систем",
                        "Оценка экономической целесообразности проекта"
                    ]
                },

                "Техника высоких напряжений": {
                    description: "Раздел электротехники, изучающий явления, связанные с высокими напряжениями, и методы их использования",
                    detailedExplanation: "Техника высоких напряжений занимается изучением электрических разрядов в газах, жидкостях и твердых диэлектриках, а также проектированием изоляционных конструкций и систем защиты от перенапряжений.",
                    topics: [
                        "Электрические разряды в газас",
                        "Пробой жидких и твердых диэлектриков",
                        "Перенапряжения в электрических сетях",
                        "Защита от перенапряжений",
                        "Испытания электрооборудования высоким напряжением",
                        "Изоляционные материалы и конструкции",
                        "Коронный разряд и его влияние"
                    ],
                    keyTerms: {
                        "Электрическая прочность": "Способность диэлектрика противостоять пробою под действием электрического поля",
                        "Коронный разряд": "Частичный электрический разряд в газе в неоднородном электрическом поле",
                        "Пробой": "Потеря диэлектриком изолирующих свойств под действием электрического поля",
                        "Перенапряжение": "Превышение напряжения над максимальным рабочим напряжением оборудования",
                        "Разрядник": "Устройство для защиты оборудования от перенапряжений",
                        "Ионизация": "Процесс образования ионов в газе под действием электрического поля"
                    },
                    practicalApplications: [
                        "Проектирование линий электропередачи высокого напряжения",
                        "Защита электрооборудования от грозовых и коммутационных перенапряжений",
                        "Испытание изоляции электрооборудования",
                        "Разработка систем заземления"
                    ],
                    teachers: ["Шахсинов Г.Ш."],
                    examInfo: "Экзамен включает теоретические вопросы по разрядам в диэлектриках и практические задачи по расчету изоляции.",
                    practicalTasks: [
                        "Расчет электрического поля в изоляционных конструкциях",
                        "Выбор изоляции для электрооборудования",
                        "Расчет защиты от перенапряжений",
                        "Планирование испытаний высоким напряжением"
                    ]
                },

                "Метрология": {
                    description: "Наука об измерениях, методах и средствах обеспечения их единства и требуемой точности",
                    detailedExplanation: "Метрология включает теоретические и практические аспекты измерений, разработку методов и средств измерений, установление единиц физических величин и передачу их размеров.",
                    topics: [
                        "Основы метрологии и терминология",
                        "Погрешности измерений и их классификация",
                        "Методы и средства измерений электрических величин",
                        "Поверка и калибровка средств измерений",
                        "Статистическая обработка результатов измерений",
                        "Метрологическое обеспечение производства",
                        "Стандартизация и сертификация"
                    ],
                    keyTerms: {
                        "Погрешность измерения": "Отклонение результата измерения от истинного значения измеряемой величины",
                        "Класс точности": "Обобщенная характеристика средств измерений, определяемая пределами допускаемых погрешностей",
                        "Поверка": "Совокупность операций для подтверждения соответствия средств измерений метрологическим требованиям",
                        "Калибровка": "Совокупность операций для определения действительных значений метрологических характеристик средств измерений",
                        "Единство измерений": "Состояние измерений, при котором их результаты выражены в узаконенных единицах и погрешности известны с заданной вероятностью",
                        "Эталон": "Средство измерений, обеспечивающее воспроизведение и хранение единицы величины для передачи ее размера другим средствам измерений"
                    },
                    practicalApplications: [
                        "Контроль качества продукции на производстве",
                        "Поверка и калибровка измерительных приборов",
                        "Разработка методик выполнения измерений",
                        "Метрологическая экспертиза технической документации"
                    ],
                    teachers: ["Офицерова Н.В."],
                    examInfo: "Зачет с решением практических задач по оценке погрешностей измерений.",
                    practicalTasks: [
                        "Расчет погрешностей прямых и косвенных измерений",
                        "Статистическая обработка результатов многократных измерений",
                        "Выбор средств измерений по заданным условиям",
                        "Разработка методики выполнения измерений"
                    ]
                },

                "Эксплуатация электротехнического оборудования ГЭС, ГАЭС": {
                    description: "Дисциплина, изучающая принципы работы, технического обслуживания и ремонта электрооборудования гидроэлектростанций и гидроаккумулирующих электростанций",
                    detailedExplanation: "Курс охватывает все аспекты эксплуатации основного и вспомогательного электрооборудования ГЭС и ГАЭС, включая генераторы, трансформаторы, распределительные устройства, системы управления и защиты.",
                    topics: [
                        "Эксплуатация гидрогенераторов",
                        "Эксплуатация силовых трансформаторов",
                        "Распределительные устройства высокого напряжения",
                        "Системы возбуждения гидрогенераторов",
                        "Системы управления и автоматизации",
                        "Техническое обслуживание и ремонт",
                        "Диагностика состояния оборудования"
                    ],
                    keyTerms: {
                        "Гидрогенератор": "Синхронный генератор, приводимый во вращение гидротурбиной",
                        "Система возбуждения": "Устройство для создания магнитного поля в генераторе",
                        "Распределительное устройство": "Электроустановка для приема и распределения электроэнергии",
                        "Техническое обслуживание": "Комплекс операций по поддержанию работоспособности оборудования",
                        "Текущий ремонт": "Ремонт, выполняемый для восстановления работоспособности оборудования",
                        "Капитальный ремонт": "Ремонт, выполняемый для восстановления ресурса оборудования"
                    },
                    practicalApplications: [
                        "Эксплуатация электрооборудования действующих ГЭС",
                        "Планирование ремонтов электрооборудования",
                        "Диагностика технического состояния оборудования",
                        "Разработка мероприятий по повышению надежности"
                    ],
                    teachers: ["Шахсинов Г.Ш."],
                    examInfo: "Экзамен включает вопросы по устройству и эксплуатации основного электрооборудования ГЭС.",
                    practicalTasks: [
                        "Составление графиков технического обслуживания",
                        "Разработка мероприятий по модернизации оборудования",
                        "Анализ отказов электрооборудования",
                        "Расчет экономической эффективности ремонтных мероприятий"
                    ]
                },

                "Энергетическое оборудование возобновляемой энергетики": {
                    description: "Дисциплина, изучающая оборудование для преобразования энергии возобновляемых источников в электрическую энергию",
                    detailedExplanation: "Курс охватывает принципы работы, конструктивные особенности и эксплуатационные характеристики оборудования для солнечной, ветровой, геотермальной и других видов возобновляемой энергетики.",
                    topics: [
                        "Солнечные фотоэлектрические установки",
                        "Ветроэнергетические установки",
                        "Геотермальные энергетические установки",
                        "Биоэнергетические установки",
                        "Оборудование для малой гидроэнергетики",
                        "Системы накопления энергии",
                        "Системы управления возобновляемыми источниками энергии"
                    ],
                    keyTerms: {
                        "Фотоэлектрический модуль": "Устройство, преобразующее солнечное излучение в электрическую энергию",
                        "Ветротурбина": "Устройство для преобразования кинетической энергии ветра в механическую энергию вращения",
                        "Инвертор": "Устройство для преобразования постоянного тока в переменный",
                        "Контроллер заряда": "Устройство для управления процессом заряда аккумуляторных батарей",
                        "Система накопления энергии": "Комплекс устройств для хранения электроэнергии",
                        "Микросеть": "Локальная энергосистема, способная работать как автономно, так и в составе общей сети"
                    },
                    practicalApplications: [
                        "Проектирование солнечных электростанций",
                        "Эксплуатация ветроэнергетических установок",
                        "Разработка гибридных энергосистем",
                        "Интеграция возобновляемых источников в энергосистему"
                    ],
                    teachers: ["Баламирзоев А.Г."],
                    examInfo: "Зачет с защитой проекта энергоустановки на основе возобновляемых источников энергии.",
                    practicalTasks: [
                        "Расчет производительности солнечной электростанции",
                        "Выбор оборудования для ветроэнергетической установки",
                        "Проектирование автономной энергосистемы",
                        "Оценка экономической эффективности проекта"
                    ]
                },

                "Теоретические основы использования возобновляемых источников энергии": {
                    description: "Дисциплина, изучающая физические принципы и теоретические основы преобразования энергии возобновляемых источников",
                    detailedExplanation: "Курс охватывает теоретические аспекты преобразования солнечной, ветровой, геотермальной, гидравлической и других видов возобновляемой энергии, включая термодинамические циклы, физические принципы и математические модели.",
                    topics: [
                        "Физические основы солнечной энергетики",
                        "Теория ветроэнергетики",
                        "Термодинамика геотермальных процессов",
                        "Гидродинамика гидроэнергетических установок",
                        "Биоэнергетические процессы",
                        "Математическое моделирование ВИЭ",
                        "Энергетический потенциал возобновляемых источников"
                    ],
                    keyTerms: {
                        "Солнечная постоянная": "Количество солнечной энергии, падающей на единицу площади за единицу времени вне атмосферы Земли",
                        "Коэффициент использования установленной мощности": "Отношение фактически выработанной энергии к максимально возможной за тот же период",
                        "Бете формула": "Формула для расчета максимальной теоретической эффективности ветротурбины",
                        "Геотермический градиент": "Увеличение температуры горных пород с глубиной",
                        "Гидравлический потенциал": "Энергия, содержащаяся в потоке воды",
                        "Фотосинтетическая эффективность": "Эффективность преобразования солнечной энергии в химическую энергию биомассы"
                    },
                    practicalApplications: [
                        "Оценка энергетического потенциала территории",
                        "Расчет эффективности энергоустановок ВИЭ",
                        "Оптимизация параметров энергоустановок",
                        "Прогнозирование выработки энергии"
                    ],
                    teachers: ["Алхасова Д.А."],
                    examInfo: "Экзамен включает теоретические вопросы и расчетные задачи по оценке потенциала ВИЭ.",
                    practicalTasks: [
                        "Расчет солнечной инсоляции для заданной местности",
                        "Оценка ветроэнергетического потенциала",
                        "Расчет геотермального потенциала месторождения",
                        "Моделирование работы гибридной энергосистемы"
                    ]
                },

                "Энергетические сооружения установок нетрадиционной и возобновляемой энергетики": {
                    description: "Дисциплина, изучающая конструкции, проектирование и строительство сооружений для установок нетрадиционной и возобновляемой энергетики",
                    detailedExplanation: "Курс охватывает инженерные аспекты создания энергетических сооружений для ВИЭ, включая фундаменты, несущие конструкции, здания и сооружения, а также вопросы интеграции в ландшафт и окружающую среду.",
                    topics: [
                        "Конструкции солнечных электростанций",
                        "Фундаменты ветроэнергетических установок",
                        "Сооружения геотермальных электростанций",
                        "Гидротехнические сооружения малых ГЭС",
                                                "Биоэнергетические комплексы",
                        "Интеграция в ландшафт и окружающую среду",
                        "Строительство и монтаж энергоустановок ВИЭ"
                    ],
                    keyTerms: {
                        "Солнечный трекер": "Устройство для ориентации солнечных панелей на солнце",
                        "Ветроэнергетический фундамент": "Основание ветроустановки, воспринимающее нагрузки от башни и ротора",
                        "Геотермальная скважина": "Скважина для извлечения геотермального теплоносителя",
                        "Деривационный канал": "Канал для подвода воды к турбине малой ГЭС",
                        "Биогазовая установка": "Комплекс сооружений для производства биогаза из органических отходов",
                        "Энергетический ландшафт": "Ландшафт, преобразованный для целей энергетики"
                    },
                    practicalApplications: [
                        "Проектирование фундаментов ветроустановок",
                        "Строительство солнечных электростанций",
                        "Монтаж геотермального оборудования",
                        "Интеграция энергоустановок в существующую инфраструктуру"
                    ],
                    teachers: ["Гаджи Шабанович"],
                    examInfo: "Экзамен включает вопросы по конструкциям энергетических сооружений и методы их расчета.",
                    practicalTasks: [
                        "Расчет фундамента ветроустановки",
                        "Проектирование каркаса солнечной электростанции",
                        "Разработка схемы размещения оборудования",
                        "Оценка воздействия на окружающую среду"
                    ]
                }
            },

            // Научные знания
            science: {
                physics: {
                    concepts: {
                        "Квантовая механика": "Раздел физики, описывающий поведение микрочастиц. Основные принципы: дуализм волна-частица, принцип неопределенности Гейзенберга, квантование энергии.",
                        "Термодинамика": "Наука о преобразовании энергии. Законы: сохранение энергии, рост энтропии, недостижимость абсолютного нуля.",
                        "Электромагнетизм": "Учение о электрических и магнитных явлениях. Уравнения Максвелла описывают взаимосвязь электрических и магнитных полей.",
                        "Оптика": "Раздел физики, изучающий свойства света. Включает геометрическую оптику, волновую оптику и квантовую оптику.",
                        "Ядерная физика": "Изучает структуру и свойства атомных ядер, ядерные реакции и радиоактивность."
                    }
                },
                mathematics: {
                    concepts: {
                        "Линейная алгебра": "Раздел математики, изучающий векторы, векторные пространства, линейные преобразования и системы линейных уравнений.",
                        "Математический анализ": "Изучение функций, пределов, производных, интегралов и бесконечных рядов.",
                        "Теория вероятностей": "Математическая дисциплина, изучающая случайные события и их закономерности.",
                        "Дифференциальные уравнения": "Уравнения, содержащие производные неизвестной функции. Описывают многие физические процессы."
                    }
                },
                chemistry: {
                    concepts: {
                        "Органическая химия": "Изучает соединения углерода, их структуру, свойства и реакции.",
                        "Физическая химия": "Изучает физические основы химических явлений и процессов.",
                        "Биохимия": "Наука о химических процессах в живых организмах.",
                        "Электрохимия": "Раздел химии, изучающий процессы взаимного превращения химической и электрической энергии."
                    }
                }
            },

            // Программирование и IT
            programming: {
                languages: {
                    "JavaScript": "Высокоуровневый интерпретируемый язык программирования. Основной язык для веб-разработки. Особенности: динамическая типизация, прототипное наследование, асинхронное программирование.",
                    "Python": "Высокоуровневый язык с простым синтаксисом. Широко используется в data science, AI, веб-разработке.",
                    "Java": "Объектно-ориентированный язык с строгой типизацией. Принцип 'write once, run anywhere'.",
                    "C++": "Компилируемый язык с поддержкой ООП и низкоуровневыми возможностями.",
                    "HTML/CSS": "HTML - язык разметки веб-страниц, CSS - каскадные таблицы стилей для оформления."
                },
                concepts: {
                    "Алгоритмы": "Конечная последовательность шагов для решения задачи. Оцениваются по времени выполнения и используемой памяти.",
                    "Структуры данных": "Способы организации данных для эффективного доступа и модификации. Примеры: массивы, списки, деревья, хэш-таблицы.",
                    "ООП": "Объектно-ориентированное программирование. Основные принципы: инкапсуляция, наследование, полиморфизм.",
                    "Базы данных": "Системы для хранения и управления данными. SQL и NoSQL базы данных.",
                    "Веб-разработка": "Создание веб-приложений. Frontend (клиентская часть) и Backend (серверная часть)."
                }
            },

            // Психология и саморазвитие
            psychology: {
                learning: {
                    "Метод Помодоро": "Техника управления временем: 25 минут работы, 5 минут перерыва. После 4 циклов - длинный перерыв 15-30 минут.",
                    "Интервальное повторение": "Метод запоминания с увеличивающимися интервалами между повторениями. Основан на кривой забывания Эббингауза.",
                    "Ментальные карты": "Визуальный способ организации информации. Центральная идея с ветвящимися связанными понятиями.",
                    "Глубокое погружение": "Метод полного сосредоточения на одной задаче без отвлечений."
                },
                productivity: {
                    "Тайм-менеджмент": "Искусство управления временем. Приоритизация задач, планирование, делегирование.",
                    "Целеполагание": "Метод SMART: цели должны быть Конкретными, Измеримыми, Достижимыми, Релевантными, Ограниченными во времени.",
                    "Принцип Парето": "80% результатов происходят от 20% усилий.",
                    "Матрица Эйзенхауэра": "Разделение задач по срочности и важности."
                }
            },

            // Общие знания
            general: {
                history: {
                    "История науки": "Развитие научных знаний от древних цивилизаций до современности. Научные революции Коперника, Ньютона, Эйнштейна.",
                    "История технологий": "Эволюция технологий от простых орудий до цифровых технологий. Промышленные революции.",
                    "Культурная история": "Развитие искусства, литературы, философии в историческом контексте."
                },
                philosophy: {
                    "Логика": "Наука о правильном мышлении. Формальная логика, логические операции, доказательства.",
                    "Критическое мышление": "Способность анализировать информацию, выявлять предпосылки, оценивать аргументы.",
                    "Этика": "Философская дисциплина, изучающая мораль и нравственность."
                },
                economics: {
                    "Микроэкономика": "Изучает поведение отдельных экономических агентов: домохозяйств, фирм.",
                    "Макроэкономика": "Изучает экономику как целое: ВВП, инфляция, безработица, экономический рост.",
                    "Финансовая грамотность": "Знания о управлении личными финансами, инвестировании, бюджетировании."
                }
            },

            // Ответы на общие вопросы
            responses: {
                greeting: [
                    "Привет! Я ваш продвинутый AI помощник. Обладаю расширенными знаниями в различных областях. Чем могу помочь?",
                    "Здравствуйте! Рад вас видеть. Готов ответить на вопросы любой сложности - от учебных до жизненных.",
                    "Приветствую! Как эксперт в multiple domains, могу помочь с анализом, объяснением сложных концепций или решением практических задач.",
                    "Добрый день! Ваш универсальный помощник к вашим услугам. Задавайте вопросы - отвечу максимально подробно и понятно."
                ],
                thanks: [
                    "Всегда рад помочь! Обращайтесь, если понадобится углубленный анализ или дополнительные объяснения.",
                    "Пожалуйста! Буду рад помочь с другими вопросами - мои знания охватывают множество областей.",
                    "Не за что! Если нужно более детальное объяснение или анализ с разных точек зрения - я к вашим услугам."
                ],
                capabilities: [
                    "Я могу: объяснять сложные технические и научные концепции, помогать с учебными задачами, анализировать проблемы с разных сторон, давать советы по продуктивности и обучению, обсуждать философские и культурные вопросы, помогать с программированием и IT вопросами.",
                    "Мои возможности: глубокий анализ вопросов, многоуровневое объяснение тем, решение практических задач, консультирование по широкому кругу вопросов от науки до повседневной жизни.",
                    "Как продвинутый AI, я обладаю знаниями в: технических науках, естественных науках, программировании, психологии, философии, экономике. Могу анализировать, сравнивать, делать выводы и давать развернутые объяснения."
                ]
            }
        };

        // Определение текущей недели (1 или 2)
        function getCurrentWeek() {
            const startDate = new Date('2025-09-01');
            const today = new Date();
            
            startDate.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0);
            
            const diffTime = today - startDate;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            const weekNumber = Math.floor(diffDays / 7);
            
            return (weekNumber % 2) + 1;
        }

        // Определение номера пары по времени
        function getPairNumber(time) {
            const timeSlots = [
                "8:30-10:05",  // 1 пара
                "10:15-11:50", // 2 пара
                "12:20-13:55", // 3 пара
                "14:05-15:40", // 4 пара
                "15:50-17:25", // 5 пара
                "17:35-19:10"  // 6 пара
            ];
            return timeSlots.indexOf(time) + 1;
        }

        // Глобальные переменные
        let currentWeek = getCurrentWeek();
        let currentDay = new Date().getDay();
        currentDay = currentDay === 0 ? 6 : currentDay - 1;
        
        let currentUser = null;
        let scheduleData = {};
        let userNotes = [];
        let userEvents = [];
        let currentEditingNoteId = null;
        let selectedImageFile = null;
        
        // Переменные для календаря
        let currentCalendarDate = new Date();
        let selectedCalendarDate = new Date();
        
        // Переменные для чата
        let chatHistory = [];

        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', async function() {
            console.log("Приложение загружается...");
            
            // Загружаем данные из локального кэша
            await loadFromCache();
            
            // Проверяем, есть ли сохраненный пользователь
            const savedUser = await localForage.getItem('currentUser');
            if (savedUser) {
                currentUser = savedUser;
                showAppInterface();
                await initFirebaseListeners();
            } else {
                // Создаем анонимного пользователя
                currentUser = {
                    id: 'user_' + Date.now(),
                    name: 'Пользователь',
                    isAnonymous: true
                };
                await localForage.setItem('currentUser', currentUser);
                showAppInterface();
                await initFirebaseListeners();
            }

            // Обновляем индикатор недели и дня
            updateWeekAndDayIndicator();
            
            // Установка времени последнего обновления
            updateLastUpdatedTime();
            
            // Показываем напоминание о расписании
            showScheduleReminder();
            
            // Активация текущего дня в навигации
            setupDayNavigation();
            
            // Настройка переключения тем
            const themeButton = document.getElementById('themeButton');
            const themeOptions = document.getElementById('themeOptions');
            
            themeButton.addEventListener('click', () => {
                themeOptions.style.display = themeOptions.style.display === 'flex' ? 'none' : 'flex';
            });
            
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', () => {
                    const theme = option.getAttribute('data-theme');
                    changeTheme(theme);
                    themeOptions.style.display = 'none';
                });
            });
            
            // Кнопка обновления
            document.getElementById('refreshButton').addEventListener('click', async () => {
                const refreshIcon = document.getElementById('refreshButton');
                refreshIcon.style.transition = 'transform 0.5s ease';
                refreshIcon.style.transform = 'rotate(360deg)';
                
                setTimeout(() => {
                    refreshIcon.style.transform = 'rotate(0deg)';
                    updateLastUpdatedTime();
                }, 500);
                
                // Принудительная синхронизация с Firebase
                await syncWithFirebase();
            });
            
            // Закрытие меню тем при клике вне его
            document.addEventListener('click', (e) => {
                if (!themeButton.contains(e.target) && !themeOptions.contains(e.target)) {
                    themeOptions.style.display = 'none';
                }
            });
            
            // Заметки
            document.getElementById('addNoteButton').addEventListener('click', showNoteForm);
            document.getElementById('noteCancel').addEventListener('click', hideNoteForm);
            document.getElementById('noteSubmit').addEventListener('click', saveNote);
            
            // Загрузка изображений
            document.getElementById('imageUploadButton').addEventListener('click', () => {
                document.getElementById('noteImage').click();
            });
            
            document.getElementById('noteImage').addEventListener('change', handleImageSelect);
            document.getElementById('imageRemoveButton').addEventListener('click', removeSelectedImage);
            
            // Календарь
            document.getElementById('prevMonth').addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                renderCalendar();
            });
            
            document.getElementById('nextMonth').addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                renderCalendar();
            });
            
            document.getElementById('addEventButton').addEventListener('click', addCalendarEvent);
            
            // Чат
            document.getElementById('chatSend').addEventListener('click', sendMessage);
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Первоначальная отрисовка расписания и календаря
            renderSchedule();
            renderCalendar();
            
            // Запуск таймера для отслеживания времени до конца пары
            startTimer();
            
            // Проверка состояния сети
            window.addEventListener('online', handleOnlineStatus);
            window.addEventListener('offline', handleOnlineStatus);
            handleOnlineStatus();
            
            // Регистрация Service Worker для PWA
            registerServiceWorker();
            
            // Загрузка сохранённой темы
            const savedTheme = localStorage.getItem('selectedTheme');
            if (savedTheme) {
                changeTheme(savedTheme);
            }
        });

        // Показать раздел
        function showSection(section) {
            // Скрыть все секции
            document.querySelectorAll('.section').forEach(sec => {
                sec.style.display = 'none';
            });
            
            // Показать нужную секцию
            document.getElementById(section + 'Section').style.display = 'block';
            
            // Обновить активные кнопки навигации
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Сделать активной кнопку текущего раздела
            const buttons = document.querySelectorAll('.nav-button');
            if (section === 'schedule') {
                buttons[0].classList.add('active');
            } else if (section === 'notes') {
                buttons[1].classList.add('active');
            } else if (section === 'calendar') {
                buttons[2].classList.add('active');
                renderCalendar();
            } else if (section === 'chat') {
                buttons[3].classList.add('active');
            }
            
            // Загрузить данные для секции
            if (section === 'notes') {
                renderNotes();
            } else if (section === 'schedule') {
                renderSchedule();
            }
        }

        // Обновление индикатора недели и дня
        function updateWeekAndDayIndicator() {
            // Обновляем текущую неделю и день
            currentWeek = getCurrentWeek();
            const today = new Date();
            currentDay = today.getDay();
            currentDay = currentDay === 0 ? 6 : currentDay - 1;
            
            // Обновляем индикатор недели
            document.getElementById('weekIndicator').textContent = `Неделя ${currentWeek}`;
            
            // Обновляем активный день в навигации
            const dayButtons = document.querySelectorAll('.day-button');
            dayButtons.forEach((button, index) => {
                if (index === currentDay) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
            
            // Обновляем заголовок дня
            const dayNames = ['Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота', 'Воскресенье'];
            document.querySelector('.day-title').textContent = dayNames[currentDay];
            
            // Перерисовываем расписание
            renderSchedule();
        }

        // Настройка навигации по дням
        function setupDayNavigation() {
            const dayButtons = document.querySelectorAll('.day-button');
            const dayNames = ['Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота', 'Воскресенье'];
            
            dayButtons.forEach((button, index) => {
                if (index === currentDay) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
                
                button.addEventListener('click', () => {
                    dayButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    currentDay = parseInt(button.getAttribute('data-day'));
                    
                    // Обновляем заголовок дня
                    document.querySelector('.day-title').textContent = dayNames[currentDay];
                    
                    renderSchedule();
                });
            });
        }

        // Firebase функции
        async function initFirebaseListeners() {
            console.log("Инициализация Firebase listeners...");
            
            try {
                // Загружаем расписание из Firebase
                await loadScheduleFromFirebase();
                
                // Загружаем заметки пользователя
                await loadUserNotes();
                
                // Загружаем события календаря
                await loadUserEvents();
                
                console.log("Firebase listeners успешно инициализированы");
            } catch (error) {
                console.error("Ошибка инициализации Firebase listeners:", error);
                showSyncStatus('Ошибка подключения', 'error');
            }
        }

        async function loadScheduleFromFirebase() {
            try {
                showSyncStatus('Загрузка расписания...', 'loading');
                console.log("Загрузка расписания из Firebase...");
                
                const scheduleDoc = await db.collection('settings').doc('schedule').get();
                
                if (scheduleDoc.exists) {
                    scheduleData = scheduleDoc.data();
                    console.log("Расписание загружено из Firebase:", scheduleData);
                    await saveToCache();
                    renderSchedule();
                    showSyncStatus('Расписание загружено', 'success');
                } else {
                    console.log("Расписание не найдено в Firebase, создаем начальное...");
                    // Если в Firebase нет расписания, используем локальное и сохраняем в Firebase
                    await saveDefaultScheduleToFirebase();
                }
            } catch (error) {
                console.error('Ошибка загрузки расписания:', error);
                showSyncStatus('Ошибка загрузки расписания', 'error');
                
                // Используем локальное расписание при ошибке
                await loadDefaultSchedule();
            }
        }

        async function saveDefaultScheduleToFirebase() {
            try {
                // Используем базовое расписание по умолчанию
                const defaultSchedule = {
                    0: { 
                        name: "Понедельник", 
                        lessons: [
                            { time: "8:30-10:05", name: "Релейная защита и противоаварийная автоматика", room: "1-8", teacher: "Ниналалов С.А.", type: "лекция" },
                            { time: "10:15-11:50", name: "Геотермальная энергетика", room: "1-8", teacher: "Алхасова Д.А.", type: "практика" },
                            { time: "12:20-13:55", name: "Теоретические основы использования ВЭ", room: "1-2лк", teacher: "Алхасова Д.А.", type: "практика" }
                        ]
                    },
                    1: { 
                        name: "Вторник", 
                        lessons: [
                            { time: "8:30-10:05", name: "Физкультура", room: "Спортзал", teacher: "", week: 2, type: "практика" },
                            { time: "10:15-11:50", name: "Энергетические сооружения установок нетрадиционной и ВЭ", room: "1-2лк", teacher: "Гаджи Шабанович", type: "лекция" },
                            { time: "12:20-13:55", name: "Теоретические основы использования ВЭ", room: "1-2лк", teacher: "Алхасова Д.А.", week: 1, type: "лекция" }
                        ]
                    },
                    2: { 
                        name: "Среда", 
                        lessons: [
                            { time: "8:30-10:05", name: "Энергетические сооружения установок нетрадиционной и ВЭ", room: "2-41", teacher: "Гаджи Шабанович", week: 2, type: "практика" },
                            { time: "10:15-11:50", name: "Релейная защита и противоаварийная автоматика", room: "1-2лк", teacher: "Ниналалов С.А.", type: "практика" },
                            { time: "12:20-13:55", name: "Энергетические сооружения установок нетрадиционной и ВЭ", room: "1-8", teacher: "Гаджи Шабанович", type: "семинар" }
                        ]
                    },
                    3: { 
                        name: "Четверг", 
                        lessons: [
                            { time: "10:15-11:50", name: "Техника высоких напряжений", room: "2-30", teacher: "Шахсинов Г.Ш.", type: "лекция" },
                            { time: "12:20-13:55", name: "Метрология", room: "2-30", teacher: "Офицерова Н.В.", type: "практика" },
                            { time: "14:05-15:40", name: "Метрология", room: "2-30", teacher: "Офицерова Н.В.", week: 1, type: "практика" }
                        ]
                    },
                    4: { 
                        name: "Пятница", 
                        lessons: [
                            { time: "10:15-11:50", name: "Эксплуатация электротех. оборудования ГЭС, ГАЭС", room: "2-30", teacher: "Шахсинов Г.Ш.", type: "лекция" },
                            { time: "12:20-13:55", name: "Энергетическое оборудование возобновляемой энергетики", room: "2-30", teacher: "Баламирзоев А.Г.", type: "практика" },
                            { time: "14:05-15:40", name: "Английский язык", room: "1-19", teacher: "Алибекова Д.М.", type: "практика" }
                        ]
                    },
                    5: { name: "Суббота", lessons: [] },
                    6: { name: "Воскресенье", lessons: [] }
                };
                
                await db.collection('settings').doc('schedule').set(defaultSchedule);
                scheduleData = defaultSchedule;
                await saveToCache();
                renderSchedule();
                showSyncStatus('Создано начальное расписание', 'success');
                console.log("Начальное расписание сохранено в Firebase");
            } catch (error) {
                console.error('Ошибка сохранения расписания:', error);
                showSyncStatus('Ошибка создания расписания', 'error');
            }
        }

        async function loadDefaultSchedule() {
            // Используем базовое расписание по умолчанию локально
            const defaultSchedule = {
                0: { 
                    name: "Понедельник", 
                    lessons: [
                        { time: "8:30-10:05", name: "Релейная защита и противоаварийная автоматика", room: "1-8", teacher: "Ниналалов С.А.", type: "лекция" },
                        { time: "10:15-11:50", name: "Геотермальная энергетика", room: "1-8", teacher: "Алхасова Д.А.", type: "практика" },
                        { time: "12:20-13:55", name: "Теоретические основы использования ВЭ", room: "1-2лк", teacher: "Алхасова Д.А.", type: "практика" }
                    ]
                },
                1: { 
                    name: "Вторник", 
                    lessons: [
                        { time: "8:30-10:05", name: "Физкультура", room: "Спортзал", teacher: "", week: 2, type: "практика" },
                        { time: "10:15-11:50", name: "Энергетические сооружения установок нетрадиционной и ВЭ", room: "1-2лк", teacher: "Гаджи Шабанович", type: "лекция" },
                        { time: "12:20-13:55", name: "Теоретические основы использования ВЭ", room: "1-2лк", teacher: "Алхасова Д.А.", week: 1, type: "лекция" }
                    ]
                },
                2: { 
                    name: "Среда", 
                    lessons: [
                        { time: "8:30-10:05", name: "Энергетические сооружения установок нетрадиционной и ВЭ", room: "2-41", teacher: "Гаджи Шабанович", week: 2, type: "практика" },
                        { time: "10:15-11:50", name: "Релейная защита и противоаварийная автоматика", room: "1-2лк", teacher: "Ниналалов С.А.", type: "практика" },
                        { time: "12:20-13:55", name: "Энергетические сооружения установок нетрадиционной и ВЭ", room: "1-8", teacher: "Гаджи Шабанович", type: "семинар" }
                    ]
                },
                3: { 
                    name: "Четверг", 
                    lessons: [
                        { time: "10:15-11:50", name: "Техника высоких напряжений", room: "2-30", teacher: "Шахсинов Г.Ш.", type: "лекция" },
                        { time: "12:20-13:55", name: "Метрология", room: "2-30", teacher: "Офицерова Н.В.", type: "практика" },
                        { time: "14:05-15:40", name: "Метрология", room: "2-30", teacher: "Офицерова Н.В.", week: 1, type: "практика" }
                    ]
                },
                4: { 
                    name: "Пятница", 
                    lessons: [
                        { time: "10:15-11:50", name: "Эксплуатация электротех. оборудования ГЭС, ГАЭС", room: "2-30", teacher: "Шахсинов Г.Ш.", type: "лекция" },
                        { time: "12:20-13:55", name: "Энергетическое оборудование возобновляемой энергетики", room: "2-30", teacher: "Баламирзоев А.Г.", type: "практика" },
                        { time: "14:05-15:40", name: "Английский язык", room: "1-19", teacher: "Алибекова Д.М.", type: "практика" }
                    ]
                },
                5: { name: "Суббота", lessons: [] },
                6: { name: "Воскресенье", lessons: [] }
            };
            
            scheduleData = defaultSchedule;
            await saveToCache();
            renderSchedule();
            console.log("Используется локальное расписание");
        }

        async function loadUserNotes() {
            try {
                if (!currentUser) return;
                
                const notesSnapshot = await db.collection('userNotes')
                    .where('userId', '==', currentUser.id)
                    .orderBy('date', 'desc')
                    .get();
                
                userNotes = notesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                await saveToCache();
                renderNotes();
                console.log("Заметки пользователя загружены");
            } catch (error) {
                console.error('Ошибка загрузки заметок:', error);
                // Используем локальные заметки при ошибке
                const cachedNotes = await localForage.getItem('userNotes');
                if (cachedNotes) {
                    userNotes = cachedNotes;
                    renderNotes();
                }
            }
        }

        async function loadUserEvents() {
            try {
                if (!currentUser) return;
                
                const eventsSnapshot = await db.collection('userEvents')
                    .where('userId', '==', currentUser.id)
                    .get();
                
                userEvents = eventsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                await saveToCache();
                renderCalendarEvents();
                console.log("События пользователя загружены");
            } catch (error) {
                console.error('Ошибка загрузки событий:', error);
                // Используем локальные события при ошибке
                const cachedEvents = await localForage.getItem('userEvents');
                if (cachedEvents) {
                    userEvents = cachedEvents;
                    renderCalendarEvents();
                }
            }
        }

        async function addNoteToFirebase(note) {
            try {
                // Загружаем изображение, если оно есть
                let imageUrl = null;
                if (selectedImageFile) {
                    imageUrl = await uploadImageToStorage(selectedImageFile);
                }
                
                const noteWithData = {
                    title: note.title,
                    content: note.content,
                    userId: currentUser.id,
                    date: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Добавляем URL изображения, если оно было загружено
                if (imageUrl) {
                    noteWithData.imageUrl = imageUrl;
                }
                
                const docRef = await db.collection('userNotes').add(noteWithData);
                console.log("Заметка добавлена в Firebase");
                return docRef.id;
            } catch (error) {
                console.error('Ошибка добавления заметки:', error);
                return null;
            }
        }

        async function updateNoteInFirebase(noteId, note) {
            try {
                // Загружаем новое изображение, если оно есть
                let imageUrl = note.imageUrl || null;
                if (selectedImageFile) {
                    imageUrl = await uploadImageToStorage(selectedImageFile);
                }
                
                const updateData = {
                    title: note.title,
                    content: note.content
                };
                
                // Добавляем URL изображения, если оно было загружено
                if (imageUrl) {
                    updateData.imageUrl = imageUrl;
                }
                
                await db.collection('userNotes').doc(noteId).update(updateData);
                console.log("Заметка обновлена в Firebase");
                return true;
            } catch (error) {
                console.error('Ошибка обновления заметки:', error);
                return false;
            }
        }

        async function deleteNoteFromFirebase(noteId) {
            try {
                // Получаем заметку для удаления изображения, если оно есть
                const noteDoc = await db.collection('userNotes').doc(noteId).get();
                if (noteDoc.exists) {
                    const noteData = noteDoc.data();
                    // Удаляем изображение из хранилища, если оно есть
                    if (noteData.imageUrl) {
                        await deleteImageFromStorage(noteData.imageUrl);
                    }
                }
                
                await db.collection('userNotes').doc(noteId).delete();
                console.log("Заметка удалена из Firebase");
                return true;
            } catch (error) {
                console.error('Ошибка удаления заметки:', error);
                return false;
            }
        }

        async function addEventToFirebase(event) {
            try {
                const eventWithData = {
                    title: event.title,
                    date: event.date,
                    userId: currentUser.id,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const docRef = await db.collection('userEvents').add(eventWithData);
                console.log("Событие добавлено в Firebase");
                return docRef.id;
            } catch (error) {
                console.error('Ошибка добавления события:', error);
                return null;
            }
        }

        async function deleteEventFromFirebase(eventId) {
            try {
                await db.collection('userEvents').doc(eventId).delete();
                console.log("Событие удалено из Firebase");
                return true;
            } catch (error) {
                console.error('Ошибка удаления события:', error);
                return false;
            }
        }

        async function uploadImageToStorage(file) {
            try {
                const fileName = `note_images/${currentUser.id}/${Date.now()}_${file.name}`;
                const storageRef = storage.ref().child(fileName);
                const snapshot = await storageRef.put(file);
                const downloadURL = await snapshot.ref.getDownloadURL();
                return downloadURL;
            } catch (error) {
                console.error('Ошибка загрузки изображения:', error);
                return null;
            }
        }

        async function deleteImageFromStorage(imageUrl) {
            try {
                const imageRef = storage.refFromURL(imageUrl);
                await imageRef.delete();
                console.log("Изображение удалено из хранилища");
            } catch (error) {
                console.error('Ошибка удаления изображения:', error);
            }
        }

        async function syncWithFirebase() {
            showSyncStatus('Синхронизация...', 'loading');
            try {
                await loadScheduleFromFirebase();
                await loadUserNotes();
                await loadUserEvents();
                showSyncStatus('Синхронизация завершена', 'success');
                console.log("Синхронизация завершена");
            } catch (error) {
                console.error('Ошибка синхронизации:', error);
                showSyncStatus('Ошибка синхронизации', 'error');
            }
        }

        // LocalForage функции
        async function saveToCache() {
            try {
                const cacheData = {
                    scheduleData: scheduleData,
                    userNotes: userNotes,
                    userEvents: userEvents,
                    currentWeek: currentWeek,
                    currentDay: currentDay,
                    lastUpdated: new Date().toISOString()
                };
                
                await localForage.setItem('appData', cacheData);
                await localForage.setItem('userNotes', userNotes);
                await localForage.setItem('userEvents', userEvents);
                console.log("Данные сохранены в кэш");
            } catch (error) {
                console.error('Ошибка сохранения в кэш:', error);
            }
        }

        async function loadFromCache() {
            try {
                const cachedData = await localForage.getItem('appData');
                if (cachedData) {
                    scheduleData = cachedData.scheduleData || {};
                    userNotes = cachedData.userNotes || [];
                    userEvents = cachedData.userEvents || [];
                    currentWeek = cachedData.currentWeek || currentWeek;
                    currentDay = cachedData.currentDay || currentDay;
                    
                    if (cachedData.lastUpdated) {
                        const lastUpdated = new Date(cachedData.lastUpdated);
                        document.getElementById('lastUpdated').textContent = 
                            `Обновлено: ${lastUpdated.toLocaleDateString()} ${lastUpdated.toLocaleTimeString()}`;
                    }
                    
                    renderSchedule();
                    renderNotes();
                    renderCalendar();
                    console.log("Данные загружены из кэша");
                } else {
                    console.log("Кэш пустой, будет использоваться Firebase");
                }
            } catch (error) {
                console.error('Ошибка загрузки из кэша:', error);
            }
        }

        // Функция отрисовки расписания
        function renderSchedule() {
            const scheduleContent = document.getElementById('scheduleContent');
            const dayTitle = document.querySelector('.day-title');
            
            const dayData = scheduleData[currentDay] || { name: "День", lessons: [] };
            dayTitle.textContent = dayData.name;
            
            // Фильтруем пары только для текущей недели
            const filteredLessons = (dayData.lessons || []).filter(lesson => 
                !lesson.week || lesson.week === currentWeek
            );
            
            if (filteredLessons.length === 0) {
                scheduleContent.innerHTML = '<div class="empty-schedule">Занятий нет</div>';
                return;
            }
            
            let html = '';
            filteredLessons.forEach((lesson) => {
                const pairNumber = getPairNumber(lesson.time);
                const typeClass = lesson.type === "лекция" ? "lecture" : 
                                lesson.type === "практика" ? "practice" : "seminar";
                
                const timeRemaining = getTimeRemaining(lesson.time);
                const timeRemainingHtml = timeRemaining ? 
                    `<span class="time-remaining">${timeRemaining}</span>` : '';
                
                html += `
                    <div class="lesson">
                        <div class="lesson-number">${pairNumber}</div>
                        <div class="lesson-time">${lesson.time} ${timeRemainingHtml}</div>
                        <div class="lesson-type ${typeClass}">${lesson.type}</div>
                        <div class="lesson-name">${lesson.name}</div>
                        <div class="lesson-details">
                            <div class="lesson-detail">📍 ${lesson.room}</div>
                            <div class="lesson-detail">👨‍🏫 ${lesson.teacher}</div>
                        </div>
                    </div>
                `;
            });
            
            scheduleContent.innerHTML = html;
        }

        // Функция расчета времени до конца пары
        function getTimeRemaining(lessonTime) {
            const now = new Date();
            const [startTime, endTime] = lessonTime.split('-');
            const [startHour, startMinute] = startTime.split(':').map(Number);
            const [endHour, endMinute] = endTime.split(':').map(Number);
            
            const lessonStart = new Date();
            lessonStart.setHours(startHour, startMinute, 0, 0);
            
            const lessonEnd = new Date();
            lessonEnd.setHours(endHour, endMinute, 0, 0);
            
            // Если пара уже закончилась
            if (now > lessonEnd) return null;
            
            // Если пара еще не началась
            if (now < lessonStart) {
                const diffMs = lessonStart - now;
                const diffMins = Math.floor(diffMs / 60000);
                return `Начнется через ${diffMins} мин`;
            }
            
            // Если пара идет сейчас
            const diffMs = lessonEnd - now;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const remainingMins = diffMins % 60;
            
            if (diffHours > 0) {
                return `Осталось ${diffHours}ч ${remainingMins}мин`;
            } else {
                return `Осталось ${remainingMins} мин`;
            }
        }

        // Запуск таймера для обновления времени до конца пары
        function startTimer() {
            setInterval(() => {
                renderSchedule();
            }, 60000); // Обновляем каждую минуту
        }

        // Функция смены темы
        function changeTheme(themeName) {
            document.body.classList.remove('theme-glass', 'theme-dark', 'theme-nature', 'theme-galaxy');
            
            if (themeName !== 'default') {
                document.body.classList.add(`theme-${themeName}`);
            }
            
            // Сохранение выбранной темы в localStorage
            localStorage.setItem('selectedTheme', themeName);
        }

        // Функции синхронизации и статуса
        function showSyncStatus(message, type) {
            const syncStatus = document.getElementById('syncStatus');
            const syncText = document.getElementById('syncText');
            
            syncText.textContent = message;
            syncStatus.style.display = 'flex';
            
            // Устанавливаем цвет в зависимости от типа
            syncStatus.style.background = type === 'success' ? 'var(--success)' : 
                                type === 'error' ? 'var(--danger)' : 'var(--primary)';
            
            // Автоматически скрываем через 3 секунды
            setTimeout(() => {
                syncStatus.style.display = 'none';
            }, 3000);
        }

        function handleOnlineStatus() {
            const notification = document.getElementById('offlineNotification');
            if (!navigator.onLine) {
                notification.style.display = 'flex';
                showSyncStatus('Оффлайн режим', 'warning');
            } else {
                notification.style.display = 'none';
                // При появлении интернета синхронизируемся
                syncWithFirebase();
            }
        }

        // Обновление времени последнего обновления
        function updateLastUpdatedTime() {
            const now = new Date();
            document.getElementById('lastUpdated').textContent = `Обновлено: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
        }

        function showAppInterface() {
            // Показываем навигацию и расписание по умолчанию
            document.querySelector('.app-navigation').style.display = 'flex';
            document.getElementById('scheduleSection').style.display = 'block';
            document.getElementById('notesSection').style.display = 'none';
            document.getElementById('calendarSection').style.display = 'none';
            document.getElementById('chatSection').style.display = 'none';
            
            renderNotes();
        }

        function renderNotes() {
            const notesContent = document.getElementById('notesContent');
            
            // Убедимся, что кнопка добавления заметки видна
            document.getElementById('addNoteButton').style.display = 'block';
            document.getElementById('noteForm').style.display = 'none';
            
            if (userNotes.length === 0) {
                notesContent.innerHTML = '<div class="empty-schedule">Заметок пока нет. Нажмите "Добавить заметку" чтобы создать первую.</div>';
                return;
            }
            
            // Рендеринг заметок пользователя
            let html = '';
            userNotes.forEach((note, index) => {
                const noteDate = note.date ? new Date(note.date.seconds ? note.date.seconds * 1000 : note.date) : new Date();
                const imageHtml = note.imageUrl ? `<img src="${note.imageUrl}" class="image-preview" style="display: block; max-width: 100%; margin-top: 10px;">` : '';
                
                html += `
                    <div class="note">
                        <div class="note-title">${note.title}</div>
                        <div class="note-content">${note.content}</div>
                        ${imageHtml}
                        <div class="note-date">${noteDate.toLocaleDateString()}</div>
                        <button class="logout-button" onclick="editNote('${note.id}')" style="margin-top: 10px; margin-right: 10px;">Редактировать</button>
                        <button class="logout-button" onclick="deleteNote('${note.id}')" style="margin-top: 10px;">Удалить</button>
                    </div>
                `;
            });
            notesContent.innerHTML = html;
        }

        function showNoteForm() {
            document.getElementById('noteForm').style.display = 'block';
            document.getElementById('addNoteButton').style.display = 'none';
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteContent').value = '';
            document.getElementById('noteSubmit').textContent = 'Сохранить';
            document.getElementById('noteSubmit').onclick = saveNote;
            
            // Сбрасываем состояние формы
            currentEditingNoteId = null;
            resetImageForm();
        }

        function hideNoteForm() {
            document.getElementById('noteForm').style.display = 'none';
            document.getElementById('addNoteButton').style.display = 'block';
            
            // Сбрасываем состояние формы
            currentEditingNoteId = null;
            resetImageForm();
        }

        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('imagePreview').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                    document.getElementById('imageRemoveButton').style.display = 'block';
                };
                reader.readAsDataURL(file);
                selectedImageFile = file;
            }
        }

        function removeSelectedImage() {
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('imageRemoveButton').style.display = 'none';
            document.getElementById('noteImage').value = '';
            selectedImageFile = null;
        }

        function resetImageForm() {
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('imageRemoveButton').style.display = 'none';
            document.getElementById('noteImage').value = '';
            selectedImageFile = null;
        }

        async function saveNote() {
            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteContent').value.trim();
            
            if (!title || !content) {
                alert('Заполните все поля');
                return;
            }
            
            const noteData = {
                title: title,
                content: content
            };
            
            let success = false;
            
            if (currentEditingNoteId) {
                // Редактирование существующей заметки
                success = await updateNoteInFirebase(currentEditingNoteId, noteData);
                
                if (success) {
                    // При успешном обновлении в Firebase, обновляем локально
                    const noteIndex = userNotes.findIndex(n => n.id === currentEditingNoteId);
                    if (noteIndex !== -1) {
                        userNotes[noteIndex].title = title;
                        userNotes[noteIndex].content = content;
                        
                        // Обновляем URL изображения, если оно было загружено
                        if (selectedImageFile) {
                            const imageUrl = await uploadImageToStorage(selectedImageFile);
                            if (imageUrl) {
                                userNotes[noteIndex].imageUrl = imageUrl;
                            }
                        }
                        
                        await saveToCache();
                        renderNotes();
                        hideNoteForm();
                        showSyncStatus('Заметка обновлена', 'success');
                    }
                } else {
                    // Если ошибка Firebase, обновляем локально
                    const noteIndex = userNotes.findIndex(n => n.id === currentEditingNoteId);
                    if (noteIndex !== -1) {
                        userNotes[noteIndex].title = title;
                        userNotes[noteIndex].content = content;
                        await saveToCache();
                        renderNotes();
                        hideNoteForm();
                        showSyncStatus('Обновлено локально (ошибка сети)', 'warning');
                    }
                }
            } else {
                // Создание новой заметки
                const noteId = await addNoteToFirebase(noteData);
                
                if (noteId) {
                    // При успешном сохранении в Firebase, добавляем в локальный список
                    const newNote = {
                        id: noteId,
                        title: title,
                        content: content,
                        userId: currentUser.id,
                        date: new Date().toISOString()
                    };
                    
                    // Добавляем URL изображения, если оно было загружено
                    if (selectedImageFile) {
                        const imageUrl = await uploadImageToStorage(selectedImageFile);
                        if (imageUrl) {
                            newNote.imageUrl = imageUrl;
                        }
                    }
                    
                    userNotes.unshift(newNote);
                    await saveToCache();
                    renderNotes();
                    hideNoteForm();
                    showSyncStatus('Заметка сохранена', 'success');
                } else {
                    // Если ошибка Firebase, сохраняем локально
                    const newNote = {
                        id: 'local_' + Date.now(),
                        title: title,
                        content: content,
                        userId: currentUser.id,
                        date: new Date().toISOString()
                    };
                    
                    userNotes.unshift(newNote);
                    await saveToCache();
                    renderNotes();
                    hideNoteForm();
                    showSyncStatus('Сохранено локально (ошибка сети)', 'warning');
                }
            }
        }

        function editNote(noteId) {
            const note = userNotes.find(n => n.id === noteId);
            if (!note) return;
            
            document.getElementById('noteTitle').value = note.title;
            document.getElementById('noteContent').value = note.content;
            document.getElementById('noteForm').style.display = 'block';
            document.getElementById('addNoteButton').style.display = 'none';
            document.getElementById('noteSubmit').textContent = 'Обновить';
            document.getElementById('noteSubmit').onclick = saveNote;
            
            // Устанавливаем текущую редактируемую заметку
            currentEditingNoteId = noteId;
            
            // Если у заметки есть изображение, показываем его
            if (note.imageUrl) {
                document.getElementById('imagePreview').src = note.imageUrl;
                document.getElementById('imagePreview').style.display = 'block';
                document.getElementById('imageRemoveButton').style.display = 'block';
                selectedImageFile = null; // Не перезаписываем существующее изображение
            } else {
                resetImageForm();
            }
        }

        async function deleteNote(noteId) {
            if (confirm('Вы уверены, что хотите удалить эту заметку?')) {
                // Пытаемся удалить из Firebase
                const success = await deleteNoteFromFirebase(noteId);
                
                if (success || noteId.startsWith('local_')) {
                    // Если успешно удалено из Firebase или это локальная заметка
                    const noteIndex = userNotes.findIndex(note => note.id === noteId);
                    if (noteIndex !== -1) {
                        userNotes.splice(noteIndex, 1);
                        await saveToCache();
                        renderNotes();
                        showSyncStatus('Заметка удалена', 'success');
                    }
                } else {
                    showSyncStatus('Ошибка удаления', 'error');
                }
            }
        }

        // Функции для календаря
        function renderCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            const calendarTitle = document.getElementById('calendarTitle');
            
            // Устанавливаем заголовок календаря
            const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 
                               'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
            calendarTitle.textContent = `${monthNames[currentCalendarDate.getMonth()]} ${currentCalendarDate.getFullYear()}`;
            
            // Очищаем сетку календаря
            calendarGrid.innerHTML = '';
            
            // Добавляем заголовки дней недели
            const dayNames = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
            dayNames.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            // Получаем первый день месяца и количество дней в месяце
            const firstDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
            const lastDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            // Определяем день недели первого дня месяца (0 - воскресенье, 1 - понедельник, ...)
            let firstDayOfWeek = firstDay.getDay();
            // Преобразуем: воскресенье (0) -> 6, понедельник (1) -> 0, и т.д.
            firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;
            
            // Добавляем пустые ячейки для дней предыдущего месяца
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day other-month';
                calendarGrid.appendChild(emptyDay);
            }
            
            // Добавляем дни текущего месяца
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                
                // Проверяем, является ли день сегодняшним
                if (currentCalendarDate.getFullYear() === today.getFullYear() &&
                    currentCalendarDate.getMonth() === today.getMonth() &&
                    day === today.getDate()) {
                    dayElement.classList.add('today');
                }
                
                // Проверяем, есть ли события на этот день
                const dayDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), day);
                const dayEvents = getUserEventsForDate(dayDate);
                if (dayEvents.length > 0) {
                    dayElement.style.background = 'var(--primary)';
                    dayElement.style.color = 'white';
                }
                
                dayElement.addEventListener('click', () => {
                    selectCalendarDate(new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), day));
                });
                
                calendarGrid.appendChild(dayElement);
            }
            
            // Обновляем отображение событий для выбранной даты
            renderCalendarEvents();
        }

        function selectCalendarDate(date) {
            selectedCalendarDate = date;
            renderCalendarEvents();
        }

        function getUserEventsForDate(date) {
            return userEvents.filter(event => {
                const eventDate = event.date.toDate ? event.date.toDate() : new Date(event.date);
                return eventDate.getDate() === date.getDate() &&
                       eventDate.getMonth() === date.getMonth() &&
                       eventDate.getFullYear() === date.getFullYear();
            });
        }

        function renderCalendarEvents() {
            const calendarEvents = document.getElementById('calendarEvents');
            const eventsForSelectedDate = getUserEventsForDate(selectedCalendarDate);
            
            if (eventsForSelectedDate.length === 0) {
                calendarEvents.innerHTML = '<div class="empty-schedule">Событий на выбранную дату нет</div>';
                return;
            }
            
            let html = '<h3>События на ' + selectedCalendarDate.toLocaleDateString() + '</h3>';
            
            eventsForSelectedDate.forEach(event => {
                html += `
                    <div class="calendar-event">
                        <div class="event-title">${event.title}</div>
                        <button class="logout-button" onclick="deleteCalendarEvent('${event.id}')" style="margin-top: 5px;">Удалить</button>
                    </div>
                `;
            });
            
            calendarEvents.innerHTML = html;
        }

        async function addCalendarEvent() {
            const eventTitle = prompt('Введите название события:');
            if (!eventTitle) return;
            
            const eventData = {
                title: eventTitle,
                date: selectedCalendarDate
            };
            
            const eventId = await addEventToFirebase(eventData);
            
            if (eventId) {
                // При успешном сохранении в Firebase, добавляем в локальный список
                const newEvent = {
                    id: eventId,
                    title: eventTitle,
                    date: selectedCalendarDate,
                    userId: currentUser.id
                };
                
                userEvents.push(newEvent);
                await saveToCache();
                renderCalendar();
                showSyncStatus('Событие добавлено', 'success');
                
                // Пытаемся добавить в системный календарь
                if ('Notification' in window && 'serviceWorker' in navigator) {
                    addToDeviceCalendar(eventTitle, selectedCalendarDate);
                }
            } else {
                // Если ошибка Firebase, сохраняем локально
                const newEvent = {
                    id: 'local_' + Date.now(),
                    title: eventTitle,
                    date: selectedCalendarDate,
                    userId: currentUser.id
                };
                
                userEvents.push(newEvent);
                await saveToCache();
                renderCalendar();
                showSyncStatus('Событие добавлено локально (ошибка сети)', 'warning');
            }
        }

        async function deleteCalendarEvent(eventId) {
            if (confirm('Вы уверены, что хотите удалить это событие?')) {
                // Пытаемся удалить из Firebase
                const success = await deleteEventFromFirebase(eventId);
                
                if (success || eventId.startsWith('local_')) {
                    // Если успешно удалено из Firebase или это локальное событие
                    const eventIndex = userEvents.findIndex(event => event.id === eventId);
                    if (eventIndex !== -1) {
                        userEvents.splice(eventIndex, 1);
                        await saveToCache();
                        renderCalendar();
                        showSyncStatus('Событие удалено', 'success');
                    }
                } else {
                    showSyncStatus('Ошибка удаления', 'error');
                }
            }
        }

        function addToDeviceCalendar(title, date) {
            // Эта функция пытается добавить событие в системный календарь устройства
            // В реальном приложении это потребует использования API календаря или создания файла .ics
            
            // Создаем уведомление о событии
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Событие добавлено в календарь', {
                    body: `${title} - ${date.toLocaleDateString()}`,
                    icon: 'icons/icon-192x192.png'
                });
            }
            
            // Показываем сообщение о том, как добавить в календарь вручную
            alert(`Событие "${title}" создано. Для добавления в системный календарь скопируйте эту информацию и добавьте вручную.`);
        }

        // УЛУЧШЕННЫЕ ФУНКЦИИ ДЛЯ AI ПОМОЩНИКА
        class AdvancedAI {
            constructor() {
                this.knowledgeBase = advancedKnowledgeBase;
                this.conversationContext = [];
            }

            // Основной метод обработки запроса
            async processQuery(userMessage) {
                // Добавляем контекст
                this.conversationContext.push({ role: 'user', content: userMessage });
                
                // Анализируем запрос
                const analysis = this.analyzeQuery(userMessage);
                
                // Генерируем ответ
                const response = await this.generateResponse(userMessage, analysis);
                
                // Сохраняем контекст
                this.conversationContext.push({ role: 'assistant', content: response });
                
                // Ограничиваем размер контекста
                if (this.conversationContext.length > 10) {
                    this.conversationContext = this.conversationContext.slice(-10);
                }
                
                return response;
            }

            // Анализ запроса
            analyzeQuery(message) {
                const lowerMessage = message.toLowerCase();
                const analysis = {
                    intent: 'unknown',
                    domains: [],
                    complexity: 'basic',
                    requiresReasoning: false,
                    keywords: []
                };

                // Определение намерения
                if (this.isGreeting(lowerMessage)) analysis.intent = 'greeting';
                else if (this.isQuestionAboutSchedule(lowerMessage)) analysis.intent = 'schedule';
                else if (this.isTechnicalQuestion(lowerMessage)) analysis.intent = 'technical';
                else if (this.isScienceQuestion(lowerMessage)) analysis.intent = 'science';
                else if (this.isProgrammingQuestion(lowerMessage)) analysis.intent = 'programming';
                else if (this.isPsychologyQuestion(lowerMessage)) analysis.intent = 'psychology';
                else if (this.isGeneralKnowledgeQuestion(lowerMessage)) analysis.intent = 'general';
                else if (this.isThanks(lowerMessage)) analysis.intent = 'thanks';
                else if (this.isCapabilitiesQuestion(lowerMessage)) analysis.intent = 'capabilities';

                // Определение доменов знаний
                if (this.isInDomain(lowerMessage, 'техническ')) analysis.domains.push('technical');
                if (this.isInDomain(lowerMessage, 'науч')) analysis.domains.push('science');
                if (this.isInDomain(lowerMessage, 'программир')) analysis.domains.push('programming');
                if (this.isInDomain(lowerMessage, 'психолог')) analysis.domains.push('psychology');
                if (this.isInDomain(lowerMessage, 'философ')) analysis.domains.push('general');

                // Определение сложности
                if (this.containsComplexTerms(lowerMessage)) analysis.complexity = 'advanced';
                if (this.requiresStepByStep(lowerMessage)) analysis.requiresReasoning = true;

                // Извлечение ключевых слов
                analysis.keywords = this.extractKeywords(lowerMessage);

                return analysis;
            }

            // Генерация ответа
            async generateResponse(userMessage, analysis) {
                // Имитация обработки
                await this.simulateThinking();

                switch (analysis.intent) {
                    case 'greeting':
                        return this.getGreetingResponse();
                    case 'schedule':
                        return this.getScheduleResponse(userMessage);
                    case 'technical':
                        return this.getTechnicalResponse(userMessage, analysis);
                    case 'science':
                        return this.getScienceResponse(userMessage, analysis);
                    case 'programming':
                        return this.getProgrammingResponse(userMessage, analysis);
                    case 'psychology':
                        return this.getPsychologyResponse(userMessage, analysis);
                    case 'general':
                        return this.getGeneralResponse(userMessage, analysis);
                    case 'thanks':
                        return this.getThanksResponse();
                    case 'capabilities':
                        return this.getCapabilitiesResponse();
                    default:
                        return this.getDefaultResponse(userMessage, analysis);
                }
            }

            // Вспомогательные методы анализа
            isGreeting(message) {
                return /привет|здравств|хай|добрый|hello|hi|hey/i.test(message);
            }

            isThanks(message) {
                return /спасибо|благодарю|thanks|thank you/i.test(message);
            }

            isCapabilitiesQuestion(message) {
                return /что ты умеешь|твои возможности|что можешь/i.test(message);
            }

            isQuestionAboutSchedule(message) {
                return /расписан|пара|заняти|когда|во сколько|пары|schedule/i.test(message);
            }

            isTechnicalQuestion(message) {
                const technicalTerms = [
                    'релейная', 'защита', 'геотермаль', 'энергетик', 'трансформатор',
                    'напряжен', 'электричеств', 'генератор', 'схем', 'расчет',
                    'метролог', 'высокое напряжение', 'эксплуатация', 'оборудование',
                    'возобновляемая энергетика', 'энергетическое оборудование',
                    'энергетические сооружения', 'теоретические основы'
                ];
                return technicalTerms.some(term => message.includes(term));
            }

            isScienceQuestion(message) {
                const scienceTerms = [
                    'физик', 'хими', 'математик', 'квантов', 'термодинамик',
                    'атом', 'молекул', 'наук'
                ];
                return scienceTerms.some(term => message.includes(term));
            }

            isProgrammingQuestion(message) {
                const programmingTerms = [
                    'программир', 'код', 'алгоритм', 'javascript', 'python',
                    'java', 'html', 'css', 'база данных', 'функция'
                ];
                return programmingTerms.some(term => message.includes(term));
            }

            isPsychologyQuestion(message) {
                const psychologyTerms = [
                    'психолог', 'мотивац', 'продуктив', 'памят', 'обучен',
                    'мышлен', 'эмоц', 'поведен', 'привычк'
                ];
                return psychologyTerms.some(term => message.includes(term));
            }

            isGeneralKnowledgeQuestion(message) {
                const generalTerms = [
                    'философ', 'истори', 'экономик', 'культур', 'общество',
                    'политик', 'искусств', 'литератур'
                ];
                return generalTerms.some(term => message.includes(term));
            }

            isInDomain(message, domain) {
                return message.includes(domain);
            }

            containsComplexTerms(message) {
                const complexTerms = [
                    'дифференциальн', 'интеграл', 'квантов', 'релятивистск',
                    'трансцендентн', 'мультивариативн', 'статистическ'
                ];
                return complexTerms.some(term => message.includes(term));
            }

            requiresStepByStep(message) {
                return /объясни по шагам|как работает|принцип действия|поэтапн/i.test(message);
            }

            extractKeywords(message) {
                // Простая реализация извлечения ключевых слов
                const words = message.split(/\s+/);
                const stopWords = ['и', 'или', 'но', 'в', 'на', 'с', 'по', 'о', 'об', 'не'];
                return words.filter(word => 
                    word.length > 3 && !stopWords.includes(word.toLowerCase())
                );
            }

            // Методы генерации ответов
            getGreetingResponse() {
                const greetings = this.knowledgeBase.responses.greeting;
                return greetings[Math.floor(Math.random() * greetings.length)];
            }

            getThanksResponse() {
                const thanks = this.knowledgeBase.responses.thanks;
                return thanks[Math.floor(Math.random() * thanks.length)];
            }

            getCapabilitiesResponse() {
                const capabilities = this.knowledgeBase.responses.capabilities;
                return capabilities[Math.floor(Math.random() * capabilities.length)];
            }

            getScheduleResponse(message) {
                // Используем существующую логику расписания
                return generateScheduleResponse(message);
            }

            getTechnicalResponse(message, analysis) {
                // Поиск по техническим предметам
                for (const [subject, info] of Object.entries(this.knowledgeBase.technical)) {
                    if (message.toLowerCase().includes(subject.toLowerCase())) {
                        return this.generateDetailedSubjectResponse(subject, info, message);
                    }
                    
                    // Поиск по ключевым терминам
                    for (const term of Object.keys(info.keyTerms)) {
                        if (message.toLowerCase().includes(term.toLowerCase())) {
                            return `**${term}** - ${info.keyTerms[term]}\n\nЭто понятие относится к предмету "${subject}". ${info.detailedExplanation || ''}`;
                        }
                    }
                }
                
                return "Могу подробно объяснить любой технический вопрос из вашей учебной программы. Уточните, что именно вас интересует?";
            }

            getScienceResponse(message, analysis) {
                for (const [field, concepts] of Object.entries(this.knowledgeBase.science)) {
                    for (const [concept, explanation] of Object.entries(concepts.concepts)) {
                        if (message.toLowerCase().includes(concept.toLowerCase())) {
                            let response = `**${concept}**\n\n${explanation}`;
                            
                            if (analysis.requiresReasoning) {
                                response += `\n\n**Пошаговое объяснение:**\n1. Основные принципы ${concept.toLowerCase()}\n2. Ключевые формулы и законы\n3. Практическое применение\n4. Связь с другими областями науки`;
                            }
                            
                            return response;
                        }
                    }
                }
                
                return "Могу объяснить концепции из физики, математики, химии и других наук. Что конкретно вас интересует?";
            }

            getProgrammingResponse(message, analysis) {
                // Поиск по языкам программирования
                for (const [language, info] of Object.entries(this.knowledgeBase.programming.languages)) {
                    if (message.toLowerCase().includes(language.toLowerCase())) {
                        return `**${language}**\n\n${info}\n\nОсновные особенности:\n• ${Object.keys(this.knowledgeBase.programming.concepts).slice(0, 3).join('\n• ')}`;
                    }
                }
                
                // Поиск по концепциям программирования
                for (const [concept, explanation] of Object.entries(this.knowledgeBase.programming.concepts)) {
                    if (message.toLowerCase().includes(concept.toLowerCase())) {
                        return `**${concept}**\n\n${explanation}`;
                    }
                }
                
                return "Могу помочь с вопросами по программированию: JavaScript, Python, Java, алгоритмы, структуры данных, веб-разработка. Что конкретно вас интересует?";
            }

            getPsychologyResponse(message, analysis) {
                for (const [category, methods] of Object.entries(this.knowledgeBase.psychology)) {
                    for (const [method, description] of Object.entries(methods)) {
                        if (message.toLowerCase().includes(method.toLowerCase())) {
                            return `**${method}**\n\n${description}`;
                        }
                    }
                }
                
                return "Могу рассказать о методах обучения, продуктивности, тайм-менеджменте и психологических аспектах учебы. Что именно вас интересует?";
            }

            getGeneralResponse(message, analysis) {
                for (const [field, topics] of Object.entries(this.knowledgeBase.general)) {
                    for (const [topic, description] of Object.entries(topics)) {
                        if (message.toLowerCase().includes(topic.toLowerCase())) {
                            return `**${topic}**\n\n${description}`;
                        }
                    }
                }
                
                return "Могу обсудить вопросы истории, философии, экономики и других общих тем. Что конкретно вас интересует?";
            }

            getDefaultResponse(message, analysis) {
                if (analysis.keywords.length > 0) {
                    return `Интересный вопрос! К сожалению, я не нашел точного ответа по теме "${analysis.keywords[0]}". \n\nМогу помочь с:\n• Учебными вопросами по вашим предметам\n• Объяснением научных концепций\n• Советами по обучению и продуктивности\n• Вопросами программирования\n\nУточните, что именно вас интересует?`;
                }
                
                return "Извините, я не совсем понял ваш вопрос. Я специализируюсь на учебных вопросах, технических науках, программировании и общих знаниях. Можете переформулировать вопрос?";
            }

            // Вспомогательные методы
            generateDetailedSubjectResponse(subject, info, message) {
                let response = `**${subject}**\n\n${info.detailedExplanation || info.description}\n\n`;
                
                // Добавляем ключевые термины
                if (Object.keys(info.keyTerms).length > 0) {
                    response += "**Ключевые термины:**\n";
                    Object.entries(info.keyTerms).slice(0, 5).forEach(([term, definition]) => {
                        response += `• **${term}**: ${definition}\n`;
                    });
                }
                
                // Добавляем практическое применение
                if (info.practicalApplications && info.practicalApplications.length > 0) {
                    response += "\n**Практическое применение:**\n";
                    info.practicalApplications.slice(0, 3).forEach(app => {
                        response += `• ${app}\n`;
                    });
                }
                
                // Добавляем информацию о преподавателе и экзамене, если есть
                if (info.teachers) {
                    response += `\n**Преподаватель:** ${info.teachers.join(', ')}\n`;
                }
                
                if (info.examInfo) {
                    response += `\n**Информация об экзамене/зачете:** ${info.examInfo}\n`;
                }
                
                return response;
            }

            async simulateThinking() {
                // Имитация времени обработки сложных запросов
                const thinkingTime = Math.random() * 1000 + 500;
                await new Promise(resolve => setTimeout(resolve, thinkingTime));
            }
        }

        // Создаем экземпляр продвинутого AI
        const advancedAI = new AdvancedAI();

        // Обновленные функции чата
        async function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (!message) return;
            
            // Добавляем сообщение пользователя в чат
            addMessageToChat(message, 'user');
            chatInput.value = '';
            
            // Показываем индикатор набора сообщения
            showTypingIndicator();
            
            try {
                // Используем продвинутый AI
                const aiResponse = await advancedAI.processQuery(message);
                
                hideTypingIndicator();
                addMessageToChat(aiResponse, 'ai');
            } catch (error) {
                hideTypingIndicator();
                addMessageToChat('Извините, произошла ошибка при обработке запроса. Попробуйте позже.', 'ai');
                console.error('Ошибка получения ответа от AI:', error);
            }
        }

        function addMessageToChat(message, sender) {
            const chatMessages = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${sender}-message`;
            
            // Форматирование сообщения (простой markdown)
            const formattedMessage = message
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
            
            messageElement.innerHTML = formattedMessage;
            
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Сохраняем сообщение в истории
            chatHistory.push({ sender, message, timestamp: new Date() });
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'block';
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function newChat() {
            if (confirm('Начать новый чат? Текущая история будет очищена.')) {
                clearChat();
                addMessageToChat('Привет! Я ваш продвинутый AI помощник. Обладаю расширенными знаниями в различных областях. Чем могу помочь?', 'ai');
                // Сбрасываем контекст
                advancedAI.conversationContext = [];
            }
        }

        function clearChat() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            chatHistory = [];
        }

        // Функции для напоминания о расписании
        function showScheduleReminder() {
            const reminder = document.getElementById('reminderBanner');
            const now = new Date();
            const currentHour = now.getHours();
            
            // Показываем напоминание только в утренние часы (8-10 утра)
            // и только если пользователь еще не скрыл его сегодня
            const today = now.toDateString();
            const lastHidden = localStorage.getItem('reminderHidden');
            
            if (currentHour >= 8 && currentHour <= 10 && lastHidden !== today) {
                reminder.style.display = 'flex';
                
                // Автоматически скрываем через 15 секунд
                setTimeout(() => {
                    if (reminder.style.display === 'flex') {
                        hideReminder();
                    }
                }, 15000);
            }
        }

        function hideReminder() {
            const reminder = document.getElementById('reminderBanner');
            reminder.style.display = 'none';
            
            // Сохраняем дату скрытия напоминания
            const today = new Date().toDateString();
            localStorage.setItem('reminderHidden', today);
        }

        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                // Inline Service Worker для оффлайн-работы
                const swCode = `
                    const CACHE_NAME = 'schedule-app-v3';
                    const urlsToCache = [
                        '/',
                        './index.html',
                        './manifest.json'
                    ];

                    self.addEventListener('install', function(event) {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(function(cache) {
                                    console.log('Opened cache');
                                    return cache.addAll(urlsToCache);
                                })
                        );
                    });

                    self.addEventListener('fetch', function(event) {
                        event.respondWith(
                            caches.match(event.request)
                                .then(function(response) {
                                    if (response) {
                                        return response;
                                    }
                                    
                                    return fetch(event.request).then(function(response) {
                                        if(!response || response.status !== 200 || response.type !== 'basic') {
                                            return response;
                                        }
                                        
                                        var responseToCache = response.clone();
                                        
                                        caches.open(CACHE_NAME)
                                            .then(function(cache) {
                                                cache.put(event.request, responseToCache);
                                            });
                                        
                                        return response;
                                    });
                                })
                        );
                    });

                    self.addEventListener('activate', function(event) {
                        event.waitUntil(
                            caches.keys().then(function(cacheNames) {
                                return Promise.all(
                                    cacheNames.map(function(cacheName) {
                                        if (cacheName !== CACHE_NAME) {
                                            return caches.delete(cacheName);
                                        }
                                    })
                                );
                            })
                        );
                    });
                `;
                
                // Создаем Blob из кода Service Worker
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swURL = URL.createObjectURL(blob);
                
                // Регистрируем Service Worker
                navigator.serviceWorker.register(swURL)
                    .then(function(registration) {
                        console.log('Service Worker зарегистрирован:', registration);
                    })
                    .catch(function(error) {
                        console.log('Ошибка регистрации Service Worker:', error);
                    });
            }
        }

        // Сохраняем существующую функцию для обратной совместимости
        function generateScheduleResponse(userMessage) {
            const lowerMessage = userMessage.toLowerCase();
            const today = new Date();
            const dayNames = ['Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота', 'Воскресенье'];
            const currentDayName = dayNames[currentDay];
            
            // Если вопрос о сегодняшнем дне
            if (lowerMessage.includes('сегодня') || lowerMessage.includes('today')) {
                const dayData = scheduleData[currentDay] || { name: "День", lessons: [] };
                const filteredLessons = (dayData.lessons || []).filter(lesson => 
                    !lesson.week || lesson.week === currentWeek
                );
                
                if (filteredLessons.length === 0) {
                    return `Сегодня ${currentDayName}. Занятий нет, можно отдохнуть или заняться самостоятельной подготовкой!`;
                }
                
                let response = `📅 Сегодня ${currentDayName}\n\n`;
                response += filteredLessons.map(lesson => 
                    `• ${getPairNumber(lesson.time)} пара (${lesson.time}): ${lesson.name} (${lesson.room})`
                ).join('\n');
                
                return response;
            }
            
            // Если вопрос о завтрашнем дне
            if (lowerMessage.includes('завтра') || lowerMessage.includes('tomorrow')) {
                const tomorrowDay = (currentDay + 1) % 7;
                const dayData = scheduleData[tomorrowDay] || { name: "День", lessons: [] };
                const filteredLessons = (dayData.lessons || []).filter(lesson => 
                    !lesson.week || lesson.week === currentWeek
                );
                
                if (filteredLessons.length === 0) {
                    return `Завтра ${dayNames[tomorrowDay]}. Занятий нет.`;
                }
                
                let response = `📅 Завтра ${dayNames[tomorrowDay]}\n\n`;
                response += filteredLessons.map(lesson => 
                    `• ${getPairNumber(lesson.time)} пара (${lesson.time}): ${lesson.name} (${lesson.room})`
                ).join('\n');
                
                return response;
            }
            
            // Общий ответ о расписании
            return `📊 Сейчас ${currentWeek} неделя. Сегодня ${currentDayName}.\n\nВ разделе "Расписание" вы можете посмотреть занятия на все дни недели. Также могу рассказать о расписании на конкретный день или пару!`;
        }

        // Глобальные функции для использования в HTML
        window.deleteNote = deleteNote;
        window.editNote = editNote;
        window.hideReminder = hideReminder;
        window.showSection = showSection;
        window.deleteCalendarEvent = deleteCalendarEvent;
        window.newChat = newChat;
        window.clearChat = clearChat;
    </script>
</body>
</html>
